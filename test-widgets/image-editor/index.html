<!DOCTYPE html>
<html>
<head>
  <style>
    :root {
      --sn-bg-primary: #0f0f19;
      --sn-bg-secondary: #1a1a2e;
      --sn-bg-tertiary: #252538;
      --sn-text-primary: #e2e8f0;
      --sn-text-secondary: #94a3b8;
      --sn-accent-primary: #8b5cf6;
      --sn-border-primary: rgba(139, 92, 246, 0.2);

      --editor-bg: var(--sn-bg-secondary);
      --controls-bg: var(--sn-bg-tertiary);
      --accent-color: var(--sn-accent-primary);
      --slider-track: var(--sn-bg-primary);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--sn-bg-primary);
      color: var(--sn-text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .editor-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .toolbar {
      display: flex;
      gap: 8px;
      padding: 8px;
      background: var(--controls-bg);
      border-bottom: 1px solid var(--sn-border-primary);
      align-items: center;
    }

    .toolbar-btn {
      padding: 6px 12px;
      background: transparent;
      border: 1px solid var(--sn-border-primary);
      border-radius: 4px;
      color: var(--sn-text-secondary);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.15s ease;
    }

    .toolbar-btn:hover {
      background: var(--accent-color);
      color: white;
    }

    .main-area {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .canvas-area {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--editor-bg);
      overflow: hidden;
      position: relative;
    }

    .canvas-area.empty {
      border: 2px dashed var(--sn-border-primary);
      margin: 10px;
      border-radius: 8px;
    }

    .canvas-area.empty::after {
      content: 'Drop image or click Load';
      color: var(--sn-text-secondary);
      font-size: 14px;
    }

    #imageCanvas {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .controls-panel {
      width: 200px;
      background: var(--controls-bg);
      padding: 12px;
      overflow-y: auto;
      border-left: 1px solid var(--sn-border-primary);
    }

    .control-group {
      margin-bottom: 16px;
    }

    .control-label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--sn-text-secondary);
      margin-bottom: 6px;
    }

    .control-value {
      color: var(--accent-color);
      font-weight: 600;
    }

    input[type="range"] {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      background: var(--slider-track);
      border-radius: 3px;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background: var(--accent-color);
      border-radius: 50%;
      cursor: pointer;
    }

    .section-title {
      font-size: 10px;
      text-transform: uppercase;
      color: var(--sn-text-secondary);
      margin-bottom: 12px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--sn-border-primary);
    }

    .preset-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-bottom: 16px;
    }

    .preset-btn {
      padding: 6px;
      background: var(--sn-bg-primary);
      border: 1px solid var(--sn-border-primary);
      border-radius: 4px;
      color: var(--sn-text-secondary);
      cursor: pointer;
      font-size: 10px;
      transition: all 0.15s ease;
    }

    .preset-btn:hover {
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      padding: 6px 10px;
      background: var(--controls-bg);
      font-size: 11px;
      color: var(--sn-text-secondary);
      border-top: 1px solid var(--sn-border-primary);
    }

    /* Hidden file input */
    #fileInput {
      display: none;
    }
  </style>
</head>
<body>
  <div class="editor-container">
    <div class="toolbar">
      <button class="toolbar-btn" id="loadBtn">üìÅ Load</button>
      <button class="toolbar-btn" id="exportBtn">üíæ Export</button>
      <button class="toolbar-btn" id="resetBtn">‚Ü∫ Reset</button>
    </div>

    <div class="main-area">
      <div class="canvas-area empty" id="canvasArea">
        <canvas id="imageCanvas"></canvas>
      </div>

      <div class="controls-panel">
        <div class="section-title">Adjustments</div>

        <div class="control-group">
          <div class="control-label">
            <span>Brightness</span>
            <span class="control-value" id="brightnessValue">100%</span>
          </div>
          <input type="range" id="brightness" min="0" max="200" value="100">
        </div>

        <div class="control-group">
          <div class="control-label">
            <span>Contrast</span>
            <span class="control-value" id="contrastValue">100%</span>
          </div>
          <input type="range" id="contrast" min="0" max="200" value="100">
        </div>

        <div class="control-group">
          <div class="control-label">
            <span>Saturation</span>
            <span class="control-value" id="saturationValue">100%</span>
          </div>
          <input type="range" id="saturation" min="0" max="200" value="100">
        </div>

        <div class="control-group">
          <div class="control-label">
            <span>Blur</span>
            <span class="control-value" id="blurValue">0px</span>
          </div>
          <input type="range" id="blur" min="0" max="20" value="0">
        </div>

        <div class="control-group">
          <div class="control-label">
            <span>Hue Rotate</span>
            <span class="control-value" id="hueValue">0¬∞</span>
          </div>
          <input type="range" id="hue" min="0" max="360" value="0">
        </div>

        <div class="section-title">Presets</div>
        <div class="preset-buttons">
          <button class="preset-btn" data-preset="grayscale">Grayscale</button>
          <button class="preset-btn" data-preset="sepia">Sepia</button>
          <button class="preset-btn" data-preset="vivid">Vivid</button>
          <button class="preset-btn" data-preset="cool">Cool</button>
          <button class="preset-btn" data-preset="warm">Warm</button>
          <button class="preset-btn" data-preset="vintage">Vintage</button>
        </div>
      </div>
    </div>

    <div class="status-bar">
      <span id="imageInfo">No image loaded</span>
      <span id="filterStatus">No filters</span>
    </div>
  </div>

  <input type="file" id="fileInput" accept="image/*">

  <script>
    // State
    let originalImage = null;
    let filters = {
      brightness: 100,
      contrast: 100,
      saturation: 100,
      blur: 0,
      hue: 0
    };

    // DOM elements
    const canvas = document.getElementById('imageCanvas');
    const ctx = canvas.getContext('2d');
    const canvasArea = document.getElementById('canvasArea');
    const fileInput = document.getElementById('fileInput');
    const loadBtn = document.getElementById('loadBtn');
    const exportBtn = document.getElementById('exportBtn');
    const resetBtn = document.getElementById('resetBtn');
    const imageInfo = document.getElementById('imageInfo');
    const filterStatus = document.getElementById('filterStatus');

    // Emit helper
    function emit(type, payload) {
      if (window.WidgetAPI) {
        window.WidgetAPI.emitEvent({ type, scope: 'canvas', payload });
      }
    }

    function log(msg) {
      if (window.WidgetAPI) {
        window.WidgetAPI.log(msg);
      }
      console.log('[ImageEditor]', msg);
    }

    // Apply filters to canvas
    function applyFilters() {
      const filterString = [
        `brightness(${filters.brightness}%)`,
        `contrast(${filters.contrast}%)`,
        `saturate(${filters.saturation}%)`,
        `blur(${filters.blur}px)`,
        `hue-rotate(${filters.hue}deg)`
      ].join(' ');

      canvas.style.filter = filterString;

      const activeFilters = Object.entries(filters)
        .filter(([key, val]) => {
          if (key === 'blur') return val > 0;
          if (key === 'hue') return val > 0;
          return val !== 100;
        })
        .length;

      filterStatus.textContent = activeFilters > 0 ? `${activeFilters} filter(s) active` : 'No filters';

      emit('filter.changed', { ...filters });
    }

    // Update slider display
    function updateSliderDisplay(id, value) {
      const valueEl = document.getElementById(`${id}Value`);
      if (valueEl) {
        if (id === 'blur') {
          valueEl.textContent = `${value}px`;
        } else if (id === 'hue') {
          valueEl.textContent = `${value}¬∞`;
        } else {
          valueEl.textContent = `${value}%`;
        }
      }
    }

    // Load image
    function loadImage(src) {
      const img = new Image();
      img.crossOrigin = 'anonymous';

      img.onload = () => {
        originalImage = img;
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        canvasArea.classList.remove('empty');
        imageInfo.textContent = `${img.width} √ó ${img.height}`;

        emit('image.loaded', {
          width: img.width,
          height: img.height,
          src: src.substring(0, 100) + '...'
        });

        log(`Image loaded: ${img.width}x${img.height}`);
      };

      img.onerror = () => {
        log('Failed to load image');
        imageInfo.textContent = 'Failed to load';
      };

      img.src = src;
    }

    // Reset filters
    function resetFilters() {
      filters = {
        brightness: 100,
        contrast: 100,
        saturation: 100,
        blur: 0,
        hue: 0
      };

      // Update sliders
      Object.entries(filters).forEach(([key, value]) => {
        const slider = document.getElementById(key);
        if (slider) {
          slider.value = value;
          updateSliderDisplay(key, value);
        }
      });

      applyFilters();
      log('Filters reset');
    }

    // Export image
    function exportImage(format = 'png', quality = 0.9) {
      if (!originalImage) {
        log('No image to export');
        return;
      }

      // Create temp canvas with filters applied
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = originalImage.width;
      tempCanvas.height = originalImage.height;
      const tempCtx = tempCanvas.getContext('2d');

      tempCtx.filter = canvas.style.filter;
      tempCtx.drawImage(originalImage, 0, 0);

      const mimeType = `image/${format === 'jpg' ? 'jpeg' : format}`;
      const dataUrl = tempCanvas.toDataURL(mimeType, quality);

      emit('image.exported', dataUrl);
      log(`Image exported as ${format}`);

      return dataUrl;
    }

    // Presets
    const presets = {
      grayscale: { brightness: 100, contrast: 100, saturation: 0, blur: 0, hue: 0 },
      sepia: { brightness: 90, contrast: 110, saturation: 80, blur: 0, hue: 30 },
      vivid: { brightness: 105, contrast: 130, saturation: 150, blur: 0, hue: 0 },
      cool: { brightness: 100, contrast: 100, saturation: 90, blur: 0, hue: 200 },
      warm: { brightness: 105, contrast: 100, saturation: 110, blur: 0, hue: 20 },
      vintage: { brightness: 95, contrast: 90, saturation: 70, blur: 0, hue: 15 }
    };

    function applyPreset(name) {
      const preset = presets[name];
      if (!preset) return;

      filters = { ...preset };

      Object.entries(filters).forEach(([key, value]) => {
        const slider = document.getElementById(key);
        if (slider) {
          slider.value = value;
          updateSliderDisplay(key, value);
        }
      });

      applyFilters();
      log(`Applied preset: ${name}`);
    }

    // Event listeners
    loadBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => loadImage(e.target.result);
        reader.readAsDataURL(file);
      }
    });

    exportBtn.addEventListener('click', () => exportImage('png'));
    resetBtn.addEventListener('click', resetFilters);

    // Slider listeners
    ['brightness', 'contrast', 'saturation', 'blur', 'hue'].forEach(id => {
      const slider = document.getElementById(id);
      slider.addEventListener('input', (e) => {
        filters[id] = parseInt(e.target.value);
        updateSliderDisplay(id, filters[id]);
        applyFilters();
      });
    });

    // Preset buttons
    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.addEventListener('click', () => applyPreset(btn.dataset.preset));
    });

    // Drag and drop
    canvasArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      canvasArea.style.borderColor = 'var(--accent-color)';
    });

    canvasArea.addEventListener('dragleave', () => {
      canvasArea.style.borderColor = '';
    });

    canvasArea.addEventListener('drop', (e) => {
      e.preventDefault();
      canvasArea.style.borderColor = '';

      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => loadImage(e.target.result);
        reader.readAsDataURL(file);
      }
    });

    // Initialize
    function init() {
      if (!window.WidgetAPI) {
        setTimeout(init, 50);
        return;
      }

      log('Initializing Image Editor');

      // Listen for events
      window.WidgetAPI.onEvent('*', (event) => {
        switch (event.type) {
          case 'image.load':
            if (typeof event.payload === 'string') {
              loadImage(event.payload);
            } else if (event.payload?.url) {
              loadImage(event.payload.url);
            }
            break;

          case 'filter.apply':
            if (event.payload) {
              Object.entries(event.payload).forEach(([key, value]) => {
                if (key in filters) {
                  filters[key] = value;
                  const slider = document.getElementById(key);
                  if (slider) {
                    slider.value = value;
                    updateSliderDisplay(key, value);
                  }
                }
              });
              applyFilters();
            }
            break;

          case 'filter.reset':
            resetFilters();
            break;

          case 'image.export':
            const format = event.payload?.format || 'png';
            const quality = event.payload?.quality || 0.9;
            exportImage(format, quality);
            break;
        }
      });

      // Register capabilities
      if (window.WidgetAPI.registerCapabilities) {
        window.WidgetAPI.registerCapabilities({
          canEdit: ['image'],
          canNest: true,
          canBeNested: true
        });
      }

      // Emit ready
      emit('editor.ready', { capabilities: ['image'] });
      log('Image Editor ready');
    }

    init();
  </script>
</body>
</html>
