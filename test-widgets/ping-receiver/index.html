<!DOCTYPE html>
<html>

<head>
    <style>
        body {
            margin: 0;
            padding: 10px;
            font-family: sans-serif;
            background: #fdf2f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            box-sizing: border-box;
        }

        .counter {
            font-size: 48px;
            font-weight: bold;
            color: #db2777;
        }

        .label {
            color: #831843;
            margin-bottom: 10px;
        }

        .log {
            font-size: 10px;
            color: #999;
            margin-top: 10px;
            height: 20px;
        }
    </style>
</head>

<body>
    <div class="label">Pings Received</div>
    <div class="counter" id="count">0</div>
    <div class="log" id="log">Waiting...</div>

    <script>
        let count = 0;
        const countEl = document.getElementById('count');
        const logEl = document.getElementById('log');

        function handlePing(payload) {
            count++;
            countEl.innerText = count;

            const timestamp = payload?.timestamp
                ? new Date(payload.timestamp).toLocaleTimeString()
                : new Date().toLocaleTimeString();
            logEl.innerText = `Last: ${timestamp}`;

            // Animation effect
            countEl.style.transform = 'scale(1.2)';
            setTimeout(() => countEl.style.transform = 'scale(1)', 200);
        }

        // Listen for messages from host
        window.addEventListener('message', (event) => {
            const data = event.data;

            // Handle pipeline:input (from PipelineRuntime routing)
            // This is the primary way AI widgets connect
            if (data.type === 'pipeline:input' && data.portName === 'ping') {
                handlePing(data.value);
                return;
            }

            // Handle widget:event (legacy and direct events)
            // portName matches io.inputs[].id
            if (data.type === 'widget:event') {
                const eventType = data.payload?.type;
                // Accept 'ping' or legacy 'test:ping' for backwards compatibility
                if (eventType === 'ping' || eventType === 'test:ping') {
                    handlePing(data.payload?.payload);
                }
            }
        });

        // Signal ready
        window.parent.postMessage({ type: 'READY' }, '*');
    </script>
</body>

</html>
