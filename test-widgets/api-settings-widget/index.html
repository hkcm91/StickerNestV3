<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Settings Widget</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #e8e8e8;
      padding: 16px;
      min-height: 100vh;
    }

    .widget-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .widget-header svg {
      width: 24px;
      height: 24px;
      fill: #ffd700;
    }

    .widget-header h1 {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
    }

    .provider-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .provider-tab {
      padding: 8px 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: #aaa;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .provider-tab:hover {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }

    .provider-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-color: transparent;
      color: #fff;
    }

    .provider-tab .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #666;
    }

    .provider-tab .status-dot.configured {
      background: #4ade80;
    }

    .provider-tab .status-dot.invalid {
      background: #f87171;
    }

    .provider-config {
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .provider-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }

    .provider-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .provider-info h3 {
      font-size: 16px;
      color: #fff;
      margin-bottom: 2px;
    }

    .provider-info p {
      font-size: 12px;
      color: #888;
    }

    .form-group {
      margin-bottom: 14px;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      color: #aaa;
      margin-bottom: 6px;
    }

    .input-wrapper {
      position: relative;
      display: flex;
      gap: 8px;
    }

    .form-group input {
      flex: 1;
      padding: 10px 12px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      font-family: 'Monaco', 'Menlo', monospace;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group input::placeholder {
      color: #666;
    }

    .toggle-visibility {
      padding: 10px 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: #aaa;
      cursor: pointer;
      transition: all 0.2s;
    }

    .toggle-visibility:hover {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }

    .validation-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 12px;
      margin-top: 10px;
    }

    .validation-status.success {
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.3);
      color: #4ade80;
    }

    .validation-status.error {
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.3);
      color: #f87171;
    }

    .validation-status.pending {
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.3);
      color: #fbbf24;
    }

    .validation-status.none {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      color: #888;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    .btn {
      flex: 1;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: #aaa;
    }

    .btn-secondary:hover {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }

    .btn-danger {
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.3);
      color: #f87171;
    }

    .btn-danger:hover {
      background: rgba(248, 113, 113, 0.2);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .section-divider {
      height: 1px;
      background: rgba(255,255,255,0.1);
      margin: 20px 0;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .quick-action-btn {
      padding: 12px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      color: #aaa;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .quick-action-btn:hover {
      background: rgba(255,255,255,0.08);
      color: #fff;
      border-color: rgba(255,255,255,0.2);
    }

    .quick-action-btn svg {
      width: 20px;
      height: 20px;
      margin-bottom: 4px;
    }

    .quick-action-btn span {
      display: block;
      font-size: 11px;
    }

    .collapsible-section {
      margin-bottom: 12px;
    }

    .collapsible-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .collapsible-header:hover {
      background: rgba(255,255,255,0.06);
    }

    .collapsible-header h4 {
      font-size: 13px;
      font-weight: 500;
      color: #ddd;
    }

    .collapsible-header .chevron {
      transition: transform 0.2s;
    }

    .collapsible-header.open .chevron {
      transform: rotate(180deg);
    }

    .collapsible-content {
      display: none;
      padding: 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 0 0 8px 8px;
      margin-top: -4px;
    }

    .collapsible-content.open {
      display: block;
    }

    .key-summary {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }

    .key-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      font-size: 13px;
    }

    .key-item .provider-name {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .key-item .status {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .key-item .status.configured {
      background: rgba(74, 222, 128, 0.1);
      color: #4ade80;
    }

    .key-item .status.missing {
      background: rgba(255,255,255,0.05);
      color: #888;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 12px 20px;
      background: #333;
      color: #fff;
      border-radius: 8px;
      font-size: 13px;
      opacity: 0;
      transition: all 0.3s;
      z-index: 1000;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.success {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
    }

    .toast.error {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .help-link {
      font-size: 11px;
      color: #667eea;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 6px;
    }

    .help-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="widget-header">
    <svg viewBox="0 0 24 24"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
    <h1>API Settings</h1>
  </div>

  <!-- Key Summary -->
  <div class="key-summary" id="keySummary"></div>

  <!-- Provider Tabs -->
  <div class="provider-tabs" id="providerTabs"></div>

  <!-- Provider Configuration -->
  <div class="provider-config" id="providerConfig"></div>

  <!-- Quick Actions -->
  <div class="section-divider"></div>
  <div class="quick-actions">
    <button class="quick-action-btn" onclick="broadcastAllKeys()">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3.24 6.15C2.51 6.43 2 7.17 2 8v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2H8.3l8.26-3.34L15.88 1 3.24 6.15zM7 20c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm13-8h-2v-2h-2v2H4V8h16v4z"/></svg>
      <span>Broadcast Keys</span>
    </button>
    <button class="quick-action-btn" onclick="validateAllKeys()">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>
      <span>Validate All</span>
    </button>
    <button class="quick-action-btn" onclick="exportConfig()">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
      <span>Export Config</span>
    </button>
    <button class="quick-action-btn" onclick="importConfig()">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/></svg>
      <span>Import Config</span>
    </button>
  </div>

  <div id="toast" class="toast"></div>
  <input type="file" id="importInput" accept=".json" style="display: none" onchange="handleImport(event)">

  <script>
    // Provider configurations
    const PROVIDERS = {
      replicate: {
        id: 'replicate',
        name: 'Replicate',
        icon: 'ðŸ”„',
        color: '#3b82f6',
        description: 'Access thousands of AI models via API',
        keyPattern: /^r8_[a-zA-Z0-9]{37}$/,
        keyPlaceholder: 'r8_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
        helpUrl: 'https://replicate.com/account/api-tokens',
        supportsBaseUrl: false
      },
      openai: {
        id: 'openai',
        name: 'OpenAI',
        icon: 'ðŸ¤–',
        color: '#10b981',
        description: 'GPT-4, DALL-E, and more',
        keyPattern: /^sk-[a-zA-Z0-9]{32,}$/,
        keyPlaceholder: 'sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
        helpUrl: 'https://platform.openai.com/api-keys',
        supportsBaseUrl: true
      },
      stability: {
        id: 'stability',
        name: 'Stability AI',
        icon: 'ðŸŽ¨',
        color: '#8b5cf6',
        description: 'Stable Diffusion and SDXL models',
        keyPattern: /^sk-[a-zA-Z0-9]{32,}$/,
        keyPlaceholder: 'sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
        helpUrl: 'https://platform.stability.ai/account/keys',
        supportsBaseUrl: false
      },
      fal: {
        id: 'fal',
        name: 'Fal.ai',
        icon: 'âš¡',
        color: '#f59e0b',
        description: 'Fast inference for generative models',
        keyPattern: /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}:[a-f0-9]{32}$/,
        keyPlaceholder: 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
        helpUrl: 'https://fal.ai/dashboard/keys',
        supportsBaseUrl: false
      },
      custom: {
        id: 'custom',
        name: 'Custom',
        icon: 'ðŸ”§',
        color: '#6b7280',
        description: 'Configure custom API endpoint',
        keyPattern: /.+/,
        keyPlaceholder: 'Your API key',
        helpUrl: null,
        supportsBaseUrl: true
      }
    };

    // State
    let state = {
      apiKeys: {},
      selectedProvider: 'replicate',
      validationStatus: {}
    };

    // Initialize
    function init() {
      loadState();
      renderProviderTabs();
      renderKeySummary();
      renderProviderConfig();
      setupMessageHandlers();
    }

    // Load state from localStorage
    function loadState() {
      try {
        const saved = localStorage.getItem('api-settings-widget-state');
        if (saved) {
          const parsed = JSON.parse(saved);
          state = { ...state, ...parsed };
        }
      } catch (e) {
        console.error('Failed to load state:', e);
      }
    }

    // Save state to localStorage
    function saveState() {
      try {
        localStorage.setItem('api-settings-widget-state', JSON.stringify(state));
      } catch (e) {
        console.error('Failed to save state:', e);
      }
    }

    // Render provider tabs
    function renderProviderTabs() {
      const container = document.getElementById('providerTabs');
      container.innerHTML = Object.values(PROVIDERS).map(provider => {
        const hasKey = state.apiKeys[provider.id]?.apiKey;
        const isValid = state.validationStatus[provider.id] === 'valid';
        const isInvalid = state.validationStatus[provider.id] === 'invalid';

        let statusClass = '';
        if (hasKey && isValid) statusClass = 'configured';
        else if (hasKey && isInvalid) statusClass = 'invalid';

        return `
          <button class="provider-tab ${state.selectedProvider === provider.id ? 'active' : ''}"
                  onclick="selectProvider('${provider.id}')">
            <span class="status-dot ${statusClass}"></span>
            ${provider.icon} ${provider.name}
          </button>
        `;
      }).join('');
    }

    // Render key summary
    function renderKeySummary() {
      const container = document.getElementById('keySummary');
      const configuredCount = Object.values(state.apiKeys).filter(k => k?.apiKey).length;
      const totalCount = Object.keys(PROVIDERS).length;

      container.innerHTML = `
        <div class="key-item">
          <span class="provider-name">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
            API Keys Configured
          </span>
          <span class="status ${configuredCount > 0 ? 'configured' : 'missing'}">
            ${configuredCount} / ${totalCount}
          </span>
        </div>
      `;
    }

    // Select provider
    function selectProvider(providerId) {
      state.selectedProvider = providerId;
      renderProviderTabs();
      renderProviderConfig();
    }

    // Render provider configuration
    function renderProviderConfig() {
      const container = document.getElementById('providerConfig');
      const provider = PROVIDERS[state.selectedProvider];
      const keyConfig = state.apiKeys[provider.id] || {};
      const validationStatus = state.validationStatus[provider.id];

      let statusHtml = '';
      if (validationStatus === 'valid') {
        statusHtml = `<div class="validation-status success">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
          API key is valid and working
        </div>`;
      } else if (validationStatus === 'invalid') {
        statusHtml = `<div class="validation-status error">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
          API key validation failed
        </div>`;
      } else if (validationStatus === 'validating') {
        statusHtml = `<div class="validation-status pending">
          <div class="spinner"></div>
          Validating API key...
        </div>`;
      } else if (keyConfig.apiKey) {
        statusHtml = `<div class="validation-status none">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
          Key not validated yet
        </div>`;
      } else {
        statusHtml = `<div class="validation-status none">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
          No API key configured
        </div>`;
      }

      container.innerHTML = `
        <div class="provider-header">
          <div class="provider-icon" style="background: ${provider.color}20; color: ${provider.color}">
            ${provider.icon}
          </div>
          <div class="provider-info">
            <h3>${provider.name}</h3>
            <p>${provider.description}</p>
          </div>
        </div>

        <div class="form-group">
          <label>API Key</label>
          <div class="input-wrapper">
            <input type="password"
                   id="apiKeyInput"
                   placeholder="${provider.keyPlaceholder}"
                   value="${keyConfig.apiKey || ''}"
                   oninput="handleKeyInput('${provider.id}', this.value)">
            <button class="toggle-visibility" onclick="toggleKeyVisibility()">
              <svg id="visibilityIcon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
              </svg>
            </button>
          </div>
          ${provider.helpUrl ? `<a href="${provider.helpUrl}" target="_blank" class="help-link">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
            Get API key
          </a>` : ''}
        </div>

        ${provider.supportsBaseUrl ? `
        <div class="form-group">
          <label>Base URL (Optional)</label>
          <input type="text"
                 id="baseUrlInput"
                 placeholder="https://api.example.com/v1"
                 value="${keyConfig.baseUrl || ''}"
                 oninput="handleBaseUrlInput('${provider.id}', this.value)">
        </div>
        ` : ''}

        ${statusHtml}

        <div class="action-buttons">
          <button class="btn btn-primary" onclick="saveAndValidate('${provider.id}')" ${!keyConfig.apiKey ? 'disabled' : ''}>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
            Save & Validate
          </button>
          <button class="btn btn-danger" onclick="removeKey('${provider.id}')" ${!keyConfig.apiKey ? 'disabled' : ''}>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            Remove
          </button>
        </div>
      `;
    }

    // Handle key input
    function handleKeyInput(providerId, value) {
      if (!state.apiKeys[providerId]) {
        state.apiKeys[providerId] = {};
      }
      state.apiKeys[providerId].apiKey = value;
      state.validationStatus[providerId] = null;
      saveState();
      renderProviderTabs();
      renderProviderConfig();
    }

    // Handle base URL input
    function handleBaseUrlInput(providerId, value) {
      if (!state.apiKeys[providerId]) {
        state.apiKeys[providerId] = {};
      }
      state.apiKeys[providerId].baseUrl = value;
      saveState();
    }

    // Toggle key visibility
    function toggleKeyVisibility() {
      const input = document.getElementById('apiKeyInput');
      const icon = document.getElementById('visibilityIcon');

      if (input.type === 'password') {
        input.type = 'text';
        icon.innerHTML = '<path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>';
      } else {
        input.type = 'password';
        icon.innerHTML = '<path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>';
      }
    }

    // Save and validate key
    async function saveAndValidate(providerId) {
      const keyConfig = state.apiKeys[providerId];
      if (!keyConfig?.apiKey) return;

      state.validationStatus[providerId] = 'validating';
      renderProviderConfig();

      try {
        const isValid = await validateApiKey(providerId, keyConfig.apiKey);
        state.validationStatus[providerId] = isValid ? 'valid' : 'invalid';

        if (isValid) {
          showToast('API key saved and validated!', 'success');
          emitKeyUpdated(providerId, true);
        } else {
          showToast('API key validation failed', 'error');
          emitKeyUpdated(providerId, false);
        }
      } catch (error) {
        state.validationStatus[providerId] = 'invalid';
        showToast('Validation error: ' + error.message, 'error');
      }

      saveState();
      renderProviderTabs();
      renderKeySummary();
      renderProviderConfig();
    }

    // Validate API key
    async function validateApiKey(providerId, apiKey) {
      const provider = PROVIDERS[providerId];

      // First check format
      if (!provider.keyPattern.test(apiKey)) {
        return false;
      }

      // Provider-specific validation
      try {
        switch (providerId) {
          case 'replicate':
            const replicateRes = await fetch('https://api.replicate.com/v1/account', {
              headers: { 'Authorization': `Token ${apiKey}` }
            });
            return replicateRes.ok;

          case 'openai':
            const baseUrl = state.apiKeys[providerId]?.baseUrl || 'https://api.openai.com/v1';
            const openaiRes = await fetch(`${baseUrl}/models`, {
              headers: { 'Authorization': `Bearer ${apiKey}` }
            });
            return openaiRes.ok;

          case 'stability':
            const stabilityRes = await fetch('https://api.stability.ai/v1/user/account', {
              headers: { 'Authorization': `Bearer ${apiKey}` }
            });
            return stabilityRes.ok;

          case 'fal':
            // Fal.ai validation - check format only for now
            return provider.keyPattern.test(apiKey);

          case 'custom':
            // Custom provider - just check that key exists
            return apiKey.length > 0;

          default:
            return apiKey.length > 0;
        }
      } catch (error) {
        console.error('Validation error:', error);
        return false;
      }
    }

    // Remove key
    function removeKey(providerId) {
      if (confirm(`Remove API key for ${PROVIDERS[providerId].name}?`)) {
        delete state.apiKeys[providerId];
        delete state.validationStatus[providerId];
        saveState();
        renderProviderTabs();
        renderKeySummary();
        renderProviderConfig();
        showToast('API key removed', 'success');
        emitKeyUpdated(providerId, false);
      }
    }

    // Broadcast all keys to other widgets
    function broadcastAllKeys() {
      const keys = {};
      Object.entries(state.apiKeys).forEach(([provider, config]) => {
        if (config?.apiKey) {
          keys[provider] = {
            apiKey: config.apiKey,
            baseUrl: config.baseUrl,
            isValid: state.validationStatus[provider] === 'valid'
          };
        }
      });

      sendMessage('output', { outputId: 'broadcastKeys', data: keys });
      sendMessage('event', { eventName: 'api:broadcast', payload: keys });
      showToast('API keys broadcast to other widgets', 'success');
    }

    // Validate all keys
    async function validateAllKeys() {
      const providers = Object.keys(state.apiKeys).filter(p => state.apiKeys[p]?.apiKey);

      if (providers.length === 0) {
        showToast('No API keys to validate', 'error');
        return;
      }

      showToast('Validating all API keys...', 'success');

      for (const providerId of providers) {
        await saveAndValidate(providerId);
      }

      showToast('Validation complete', 'success');
    }

    // Export configuration
    function exportConfig() {
      const config = {
        providers: {},
        exportedAt: new Date().toISOString()
      };

      Object.entries(state.apiKeys).forEach(([provider, keyConfig]) => {
        if (keyConfig?.apiKey) {
          config.providers[provider] = {
            hasKey: true,
            baseUrl: keyConfig.baseUrl,
            isValid: state.validationStatus[provider] === 'valid'
          };
        }
      });

      sendMessage('output', { outputId: 'configExported', data: config });

      // Also download as JSON (without actual keys for security)
      const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'api-settings-config.json';
      a.click();
      URL.revokeObjectURL(url);

      showToast('Configuration exported', 'success');
    }

    // Import configuration
    function importConfig() {
      document.getElementById('importInput').click();
    }

    // Handle import
    function handleImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const config = JSON.parse(e.target.result);

          if (config.apiKeys) {
            state.apiKeys = { ...state.apiKeys, ...config.apiKeys };
            saveState();
            renderProviderTabs();
            renderKeySummary();
            renderProviderConfig();
            showToast('Configuration imported', 'success');
          } else {
            showToast('Invalid configuration file', 'error');
          }
        } catch (error) {
          showToast('Failed to parse configuration', 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // Emit key updated event
    function emitKeyUpdated(provider, isValid) {
      sendMessage('output', {
        outputId: 'apiKeyUpdated',
        data: { provider, isValid }
      });
      sendMessage('event', {
        eventName: 'api:key-updated',
        payload: { provider, isValid }
      });
    }

    // Show toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Send message to parent
    function sendMessage(type, payload) {
      window.parent.postMessage({ type, ...payload }, '*');
    }

    // Setup message handlers
    function setupMessageHandlers() {
      window.addEventListener('message', (event) => {
        const { type, inputId, data } = event.data;

        if (type === 'input') {
          switch (inputId) {
            case 'setApiKey':
              if (data?.provider && data?.apiKey) {
                state.apiKeys[data.provider] = {
                  apiKey: data.apiKey,
                  baseUrl: data.baseUrl
                };
                saveState();
                renderProviderTabs();
                renderKeySummary();
                if (state.selectedProvider === data.provider) {
                  renderProviderConfig();
                }
                saveAndValidate(data.provider);
              }
              break;

            case 'removeApiKey':
              if (data && PROVIDERS[data]) {
                removeKey(data);
              }
              break;

            case 'validateKey':
              if (data && state.apiKeys[data]?.apiKey) {
                saveAndValidate(data);
              }
              break;

            case 'getConfig':
              broadcastAllKeys();
              break;
          }
        }
      });

      // Notify parent that widget is ready
      sendMessage('ready', { widgetId: 'api-settings-widget' });
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
