<!DOCTYPE html>
<html>
<head>
  <style>
    :root {
      /* StickerNest Design System */
      --sn-bg-primary: #0f0f19;
      --sn-bg-secondary: #1a1a2e;
      --sn-bg-tertiary: #252538;
      --sn-text-primary: #e2e8f0;
      --sn-text-secondary: #94a3b8;
      --sn-text-muted: #64748b;
      --sn-accent-primary: #8b5cf6;
      --sn-accent-secondary: #a78bfa;
      --sn-border-primary: rgba(139, 92, 246, 0.2);
      --sn-border-hover: rgba(139, 92, 246, 0.4);
      --sn-radius-sm: 4px;
      --sn-radius-md: 6px;
      --sn-radius-lg: 8px;
      --sn-transition-fast: 0.15s ease;
      --sn-shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
      --sn-shadow-md: 0 4px 12px rgba(0,0,0,0.4);

      /* Widget-specific slots */
      --widget-bg: var(--sn-bg-primary);
      --controls-bg: var(--sn-bg-secondary);
      --accent-color: var(--sn-accent-primary);
      --text-preview: var(--sn-text-primary);
      --border-color: var(--sn-border-primary);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--widget-bg);
      color: var(--sn-text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Preview Area */
    .preview-area {
      flex: 0 0 140px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--sn-bg-tertiary) 0%, var(--sn-bg-secondary) 100%);
      border-bottom: 1px solid var(--border-color);
      padding: 16px;
      position: relative;
      overflow: hidden;
    }

    .preview-text {
      text-align: center;
      max-width: 100%;
      word-wrap: break-word;
      outline: none;
      padding: 8px;
      border-radius: var(--sn-radius-sm);
      transition: box-shadow var(--sn-transition-fast);
      cursor: text;
    }

    .preview-text:focus {
      box-shadow: 0 0 0 2px var(--accent-color);
    }

    .preview-text:empty::before {
      content: attr(data-placeholder);
      color: var(--sn-text-muted);
      opacity: 0.6;
    }

    /* Controls Panel */
    .controls-panel {
      flex: 1;
      overflow-y: auto;
      background: var(--controls-bg);
      padding: 12px;
    }

    .control-section {
      margin-bottom: 16px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--sn-text-secondary);
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border-color);
    }

    .section-header .icon {
      font-size: 12px;
      opacity: 0.7;
    }

    /* Control Row */
    .control-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .control-row.full {
      flex-direction: column;
    }

    .control-group {
      flex: 1;
      min-width: 0;
    }

    .control-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--sn-text-secondary);
      margin-bottom: 4px;
    }

    .control-value {
      color: var(--accent-color);
      font-weight: 600;
      font-size: 10px;
    }

    /* Select Dropdown */
    select {
      width: 100%;
      padding: 8px 10px;
      background: var(--sn-bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--sn-radius-sm);
      color: var(--sn-text-primary);
      font-size: 12px;
      cursor: pointer;
      transition: all var(--sn-transition-fast);
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8'%3E%3Cpath d='M6 8L2 4h8z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      padding-right: 28px;
    }

    select:hover {
      border-color: var(--sn-border-hover);
    }

    select:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
    }

    /* Range Slider */
    input[type="range"] {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      background: var(--sn-bg-primary);
      border-radius: 3px;
      outline: none;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background: var(--accent-color);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: var(--sn-shadow-sm);
      transition: transform var(--sn-transition-fast);
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.1);
    }

    /* Color Input */
    .color-input-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input[type="color"] {
      width: 36px;
      height: 32px;
      padding: 0;
      border: 2px solid var(--border-color);
      border-radius: var(--sn-radius-sm);
      cursor: pointer;
      background: none;
    }

    input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 2px;
    }

    input[type="color"]::-webkit-color-swatch {
      border: none;
      border-radius: 2px;
    }

    .color-hex {
      flex: 1;
      padding: 8px 10px;
      background: var(--sn-bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--sn-radius-sm);
      color: var(--sn-text-primary);
      font-size: 12px;
      font-family: monospace;
      text-transform: uppercase;
    }

    /* Button Groups */
    .btn-group {
      display: flex;
      gap: 4px;
    }

    .btn-group.wrap {
      flex-wrap: wrap;
    }

    .btn {
      flex: 1;
      padding: 8px 12px;
      background: var(--sn-bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--sn-radius-sm);
      color: var(--sn-text-secondary);
      font-size: 11px;
      cursor: pointer;
      transition: all var(--sn-transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .btn:hover {
      background: var(--sn-bg-tertiary);
      border-color: var(--sn-border-hover);
      color: var(--sn-text-primary);
    }

    .btn.active {
      background: var(--accent-color);
      border-color: var(--accent-color);
      color: white;
    }

    .btn.icon-only {
      flex: 0 0 36px;
      padding: 8px;
      font-size: 14px;
    }

    /* Preset Buttons */
    .preset-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .preset-btn {
      padding: 10px 8px;
      background: var(--sn-bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--sn-radius-sm);
      color: var(--sn-text-secondary);
      font-size: 10px;
      cursor: pointer;
      transition: all var(--sn-transition-fast);
      text-align: center;
    }

    .preset-btn:hover {
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    .preset-btn .preview {
      font-size: 14px;
      margin-bottom: 4px;
      color: var(--sn-text-primary);
    }

    .preset-btn[data-preset="headline"] .preview { font-weight: 700; font-size: 16px; }
    .preset-btn[data-preset="subheading"] .preview { font-weight: 600; font-size: 13px; }
    .preset-btn[data-preset="body"] .preview { font-weight: 400; font-size: 12px; }
    .preset-btn[data-preset="caption"] .preview { font-weight: 400; font-size: 10px; color: var(--sn-text-secondary); }
    .preset-btn[data-preset="quote"] .preview { font-style: italic; font-size: 13px; }
    .preset-btn[data-preset="label"] .preview { font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; }

    /* Number Input */
    input[type="number"] {
      width: 100%;
      padding: 8px 10px;
      background: var(--sn-bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--sn-radius-sm);
      color: var(--sn-text-primary);
      font-size: 12px;
      text-align: center;
    }

    input[type="number"]:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    /* Status Bar */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: var(--sn-bg-tertiary);
      border-top: 1px solid var(--border-color);
      font-size: 10px;
      color: var(--sn-text-muted);
    }

    .status-bar .font-preview {
      font-size: 11px;
      color: var(--sn-text-secondary);
    }

    /* Font weight labels */
    .weight-labels {
      display: flex;
      justify-content: space-between;
      font-size: 9px;
      color: var(--sn-text-muted);
      margin-top: 4px;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--sn-bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--sn-bg-tertiary);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-color);
    }
  </style>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Roboto:wght@100;300;400;500;700;900&family=Montserrat:wght@100;300;400;500;600;700;800;900&family=Open+Sans:wght@300;400;500;600;700;800&family=Lato:wght@100;300;400;700;900&family=Poppins:wght@100;200;300;400;500;600;700;800;900&family=Oswald:wght@200;300;400;500;600;700&family=Raleway:wght@100;200;300;400;500;600;700;800;900&family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400&family=Bebas+Neue&family=Dancing+Script:wght@400;500;600;700&family=Pacifico&family=Permanent+Marker&family=Abril+Fatface&family=Lobster&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Preview Area -->
  <div class="preview-area">
    <div
      class="preview-text"
      id="previewText"
      contenteditable="true"
      data-placeholder="Click to edit text"
    >Your Text Here</div>
  </div>

  <!-- Controls Panel -->
  <div class="controls-panel">
    <!-- Font Family Section -->
    <div class="control-section">
      <div class="section-header">
        <span>Font Family</span>
        <span class="icon">Aa</span>
      </div>
      <select id="fontFamily">
        <optgroup label="Sans-Serif">
          <option value="Inter" selected>Inter</option>
          <option value="Roboto">Roboto</option>
          <option value="Montserrat">Montserrat</option>
          <option value="Open Sans">Open Sans</option>
          <option value="Lato">Lato</option>
          <option value="Poppins">Poppins</option>
          <option value="Raleway">Raleway</option>
          <option value="Oswald">Oswald</option>
        </optgroup>
        <optgroup label="Serif">
          <option value="Playfair Display">Playfair Display</option>
          <option value="Merriweather">Merriweather</option>
          <option value="Georgia">Georgia</option>
          <option value="Times New Roman">Times New Roman</option>
          <option value="Abril Fatface">Abril Fatface</option>
        </optgroup>
        <optgroup label="Display">
          <option value="Bebas Neue">Bebas Neue</option>
          <option value="Lobster">Lobster</option>
          <option value="Permanent Marker">Permanent Marker</option>
        </optgroup>
        <optgroup label="Script">
          <option value="Dancing Script">Dancing Script</option>
          <option value="Pacifico">Pacifico</option>
        </optgroup>
        <optgroup label="System">
          <option value="system-ui">System UI</option>
          <option value="Arial">Arial</option>
          <option value="Helvetica">Helvetica</option>
          <option value="Verdana">Verdana</option>
        </optgroup>
      </select>
    </div>

    <!-- Size & Weight Section -->
    <div class="control-section">
      <div class="section-header">
        <span>Size & Weight</span>
        <span class="icon">T</span>
      </div>
      <div class="control-row">
        <div class="control-group">
          <div class="control-label">
            <span>Font Size</span>
            <span class="control-value" id="fontSizeValue">32px</span>
          </div>
          <input type="range" id="fontSize" min="8" max="200" value="32">
        </div>
      </div>
      <div class="control-row">
        <div class="control-group">
          <div class="control-label">
            <span>Font Weight</span>
            <span class="control-value" id="fontWeightValue">400</span>
          </div>
          <input type="range" id="fontWeight" min="100" max="900" step="100" value="400">
          <div class="weight-labels">
            <span>Thin</span>
            <span>Regular</span>
            <span>Bold</span>
            <span>Black</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Color Section -->
    <div class="control-section">
      <div class="section-header">
        <span>Color</span>
        <span class="icon">C</span>
      </div>
      <div class="color-input-wrapper">
        <input type="color" id="textColor" value="#e2e8f0">
        <input type="text" class="color-hex" id="colorHex" value="#E2E8F0" maxlength="7">
      </div>
    </div>

    <!-- Spacing Section -->
    <div class="control-section">
      <div class="section-header">
        <span>Spacing</span>
        <span class="icon">||</span>
      </div>
      <div class="control-row">
        <div class="control-group">
          <div class="control-label">
            <span>Letter Spacing</span>
            <span class="control-value" id="letterSpacingValue">0px</span>
          </div>
          <input type="range" id="letterSpacing" min="-10" max="30" value="0" step="0.5">
        </div>
      </div>
      <div class="control-row">
        <div class="control-group">
          <div class="control-label">
            <span>Line Height</span>
            <span class="control-value" id="lineHeightValue">1.2</span>
          </div>
          <input type="range" id="lineHeight" min="0.8" max="3" value="1.2" step="0.1">
        </div>
      </div>
      <div class="control-row">
        <div class="control-group">
          <div class="control-label">
            <span>Word Spacing</span>
            <span class="control-value" id="wordSpacingValue">0px</span>
          </div>
          <input type="range" id="wordSpacing" min="-10" max="30" value="0" step="1">
        </div>
      </div>
    </div>

    <!-- Alignment Section -->
    <div class="control-section">
      <div class="section-header">
        <span>Alignment</span>
        <span class="icon">=</span>
      </div>
      <div class="btn-group">
        <button class="btn icon-only" data-align="left" title="Align Left">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 3h18v2H3V3zm0 4h12v2H3V7zm0 4h18v2H3v-2zm0 4h12v2H3v-2zm0 4h18v2H3v-2z"/>
          </svg>
        </button>
        <button class="btn icon-only active" data-align="center" title="Align Center">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 3h18v2H3V3zm3 4h12v2H6V7zm-3 4h18v2H3v-2zm3 4h12v2H6v-2zm-3 4h18v2H3v-2z"/>
          </svg>
        </button>
        <button class="btn icon-only" data-align="right" title="Align Right">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 3h18v2H3V3zm6 4h12v2H9V7zm-6 4h18v2H3v-2zm6 4h12v2H9v-2zm-6 4h18v2H3v-2z"/>
          </svg>
        </button>
        <button class="btn icon-only" data-align="justify" title="Justify">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 3h18v2H3V3zm0 4h18v2H3V7zm0 4h18v2H3v-2zm0 4h18v2H3v-2zm0 4h18v2H3v-2z"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Transform Section -->
    <div class="control-section">
      <div class="section-header">
        <span>Text Transform</span>
        <span class="icon">Aa</span>
      </div>
      <div class="btn-group">
        <button class="btn active" data-transform="none">None</button>
        <button class="btn" data-transform="uppercase">ABC</button>
        <button class="btn" data-transform="lowercase">abc</button>
        <button class="btn" data-transform="capitalize">Abc</button>
      </div>
    </div>

    <!-- Style Options Section -->
    <div class="control-section">
      <div class="section-header">
        <span>Style Options</span>
        <span class="icon">B</span>
      </div>
      <div class="btn-group wrap">
        <button class="btn" id="toggleItalic" title="Italic">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 4v2h2.21l-3.42 12H6v2h8v-2h-2.21l3.42-12H18V4h-8z"/>
          </svg>
          Italic
        </button>
        <button class="btn" id="toggleUnderline" title="Underline">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 17c3.31 0 6-2.69 6-6V3h-2.5v8c0 1.93-1.57 3.5-3.5 3.5S8.5 12.93 8.5 11V3H6v8c0 3.31 2.69 6 6 6zm-7 2v2h14v-2H5z"/>
          </svg>
          Underline
        </button>
        <button class="btn" id="toggleStrike" title="Strikethrough">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 19h4v-3h-4v3zM5 4v3h5v3h4V7h5V4H5zM3 14h18v-2H3v2z"/>
          </svg>
          Strike
        </button>
      </div>
    </div>

    <!-- Presets Section -->
    <div class="control-section">
      <div class="section-header">
        <span>Quick Presets</span>
        <span class="icon">P</span>
      </div>
      <div class="preset-grid">
        <button class="preset-btn" data-preset="headline">
          <div class="preview">Headline</div>
          <span>Bold Title</span>
        </button>
        <button class="preset-btn" data-preset="subheading">
          <div class="preview">Subhead</div>
          <span>Section</span>
        </button>
        <button class="preset-btn" data-preset="body">
          <div class="preview">Body</div>
          <span>Paragraph</span>
        </button>
        <button class="preset-btn" data-preset="caption">
          <div class="preview">Caption</div>
          <span>Small</span>
        </button>
        <button class="preset-btn" data-preset="quote">
          <div class="preview">"Quote"</div>
          <span>Italic</span>
        </button>
        <button class="preset-btn" data-preset="label">
          <div class="preview">LABEL</div>
          <span>Uppercase</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="status-bar">
    <span id="charCount">0 characters</span>
    <span class="font-preview" id="fontPreview">Inter 400 32px</span>
  </div>

  <script>
    // ========================================
    // STATE
    // ========================================
    const state = {
      text: 'Your Text Here',
      fontFamily: 'Inter',
      fontSize: 32,
      fontWeight: 400,
      color: '#e2e8f0',
      letterSpacing: 0,
      lineHeight: 1.2,
      wordSpacing: 0,
      textAlign: 'center',
      textTransform: 'none',
      fontStyle: 'normal',
      textDecoration: 'none'
    };

    // ========================================
    // DOM ELEMENTS
    // ========================================
    const previewText = document.getElementById('previewText');
    const fontFamily = document.getElementById('fontFamily');
    const fontSize = document.getElementById('fontSize');
    const fontWeight = document.getElementById('fontWeight');
    const textColor = document.getElementById('textColor');
    const colorHex = document.getElementById('colorHex');
    const letterSpacing = document.getElementById('letterSpacing');
    const lineHeight = document.getElementById('lineHeight');
    const wordSpacing = document.getElementById('wordSpacing');
    const charCount = document.getElementById('charCount');
    const fontPreview = document.getElementById('fontPreview');

    // Value displays
    const fontSizeValue = document.getElementById('fontSizeValue');
    const fontWeightValue = document.getElementById('fontWeightValue');
    const letterSpacingValue = document.getElementById('letterSpacingValue');
    const lineHeightValue = document.getElementById('lineHeightValue');
    const wordSpacingValue = document.getElementById('wordSpacingValue');

    // ========================================
    // PRESETS
    // ========================================
    const presets = {
      headline: {
        fontFamily: 'Montserrat',
        fontSize: 48,
        fontWeight: 700,
        letterSpacing: -1,
        lineHeight: 1.1,
        textTransform: 'none'
      },
      subheading: {
        fontFamily: 'Inter',
        fontSize: 24,
        fontWeight: 600,
        letterSpacing: 0,
        lineHeight: 1.3,
        textTransform: 'none'
      },
      body: {
        fontFamily: 'Open Sans',
        fontSize: 16,
        fontWeight: 400,
        letterSpacing: 0,
        lineHeight: 1.6,
        textTransform: 'none'
      },
      caption: {
        fontFamily: 'Inter',
        fontSize: 12,
        fontWeight: 400,
        letterSpacing: 0.5,
        lineHeight: 1.4,
        textTransform: 'none'
      },
      quote: {
        fontFamily: 'Playfair Display',
        fontSize: 28,
        fontWeight: 400,
        fontStyle: 'italic',
        letterSpacing: 0,
        lineHeight: 1.5,
        textTransform: 'none'
      },
      label: {
        fontFamily: 'Inter',
        fontSize: 11,
        fontWeight: 600,
        letterSpacing: 2,
        lineHeight: 1.2,
        textTransform: 'uppercase'
      }
    };

    // ========================================
    // HELPER FUNCTIONS
    // ========================================
    function emit(type, payload) {
      if (window.WidgetAPI) {
        window.WidgetAPI.emitEvent({ type, scope: 'canvas', payload });
      }
    }

    function broadcast(type, payload) {
      if (window.WidgetAPI) {
        window.WidgetAPI.emitEvent({ type, scope: 'canvas', payload, broadcast: true });
      }
    }

    function log(msg) {
      if (window.WidgetAPI) {
        window.WidgetAPI.log(msg);
      }
      console.log('[TextStyles]', msg);
    }

    function updatePreview() {
      previewText.style.fontFamily = `"${state.fontFamily}", sans-serif`;
      previewText.style.fontSize = `${state.fontSize}px`;
      previewText.style.fontWeight = state.fontWeight;
      previewText.style.color = state.color;
      previewText.style.letterSpacing = `${state.letterSpacing}px`;
      previewText.style.lineHeight = state.lineHeight;
      previewText.style.wordSpacing = `${state.wordSpacing}px`;
      previewText.style.textAlign = state.textAlign;
      previewText.style.textTransform = state.textTransform;
      previewText.style.fontStyle = state.fontStyle;
      previewText.style.textDecoration = state.textDecoration;
    }

    function updateControls() {
      fontFamily.value = state.fontFamily;
      fontSize.value = state.fontSize;
      fontWeight.value = state.fontWeight;
      textColor.value = state.color;
      colorHex.value = state.color.toUpperCase();
      letterSpacing.value = state.letterSpacing;
      lineHeight.value = state.lineHeight;
      wordSpacing.value = state.wordSpacing;

      // Update value displays
      fontSizeValue.textContent = `${state.fontSize}px`;
      fontWeightValue.textContent = state.fontWeight;
      letterSpacingValue.textContent = `${state.letterSpacing}px`;
      lineHeightValue.textContent = state.lineHeight.toFixed(1);
      wordSpacingValue.textContent = `${state.wordSpacing}px`;

      // Update active buttons
      document.querySelectorAll('[data-align]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.align === state.textAlign);
      });
      document.querySelectorAll('[data-transform]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.transform === state.textTransform);
      });

      // Style toggles
      document.getElementById('toggleItalic').classList.toggle('active', state.fontStyle === 'italic');
      document.getElementById('toggleUnderline').classList.toggle('active', state.textDecoration.includes('underline'));
      document.getElementById('toggleStrike').classList.toggle('active', state.textDecoration.includes('line-through'));

      // Status bar
      fontPreview.textContent = `${state.fontFamily} ${state.fontWeight} ${state.fontSize}px`;
    }

    function updateCharCount() {
      const text = previewText.innerText || '';
      charCount.textContent = `${text.length} characters`;
    }

    function emitStyleChange() {
      const styleData = { ...state };
      emit('style.changed', styleData);
      broadcast('typography:style-changed', styleData);
    }

    function emitTextChange() {
      emit('text.changed', { text: state.text, styles: { ...state } });
      broadcast('typography:text-changed', { text: state.text, styles: { ...state } });
    }

    // ========================================
    // EVENT HANDLERS
    // ========================================

    // Font family
    fontFamily.addEventListener('change', (e) => {
      state.fontFamily = e.target.value;
      updatePreview();
      updateControls();
      emitStyleChange();
      log(`Font family: ${state.fontFamily}`);
    });

    // Font size
    fontSize.addEventListener('input', (e) => {
      state.fontSize = parseInt(e.target.value);
      fontSizeValue.textContent = `${state.fontSize}px`;
      updatePreview();
      updateControls();
    });
    fontSize.addEventListener('change', () => emitStyleChange());

    // Font weight
    fontWeight.addEventListener('input', (e) => {
      state.fontWeight = parseInt(e.target.value);
      fontWeightValue.textContent = state.fontWeight;
      updatePreview();
      updateControls();
    });
    fontWeight.addEventListener('change', () => emitStyleChange());

    // Color
    textColor.addEventListener('input', (e) => {
      state.color = e.target.value;
      colorHex.value = state.color.toUpperCase();
      updatePreview();
    });
    textColor.addEventListener('change', () => emitStyleChange());

    colorHex.addEventListener('input', (e) => {
      let hex = e.target.value;
      if (!hex.startsWith('#')) hex = '#' + hex;
      if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
        state.color = hex;
        textColor.value = hex;
        updatePreview();
      }
    });
    colorHex.addEventListener('change', () => emitStyleChange());

    // Letter spacing
    letterSpacing.addEventListener('input', (e) => {
      state.letterSpacing = parseFloat(e.target.value);
      letterSpacingValue.textContent = `${state.letterSpacing}px`;
      updatePreview();
    });
    letterSpacing.addEventListener('change', () => emitStyleChange());

    // Line height
    lineHeight.addEventListener('input', (e) => {
      state.lineHeight = parseFloat(e.target.value);
      lineHeightValue.textContent = state.lineHeight.toFixed(1);
      updatePreview();
    });
    lineHeight.addEventListener('change', () => emitStyleChange());

    // Word spacing
    wordSpacing.addEventListener('input', (e) => {
      state.wordSpacing = parseInt(e.target.value);
      wordSpacingValue.textContent = `${state.wordSpacing}px`;
      updatePreview();
    });
    wordSpacing.addEventListener('change', () => emitStyleChange());

    // Alignment buttons
    document.querySelectorAll('[data-align]').forEach(btn => {
      btn.addEventListener('click', () => {
        state.textAlign = btn.dataset.align;
        updatePreview();
        updateControls();
        emitStyleChange();
        log(`Text align: ${state.textAlign}`);
      });
    });

    // Transform buttons
    document.querySelectorAll('[data-transform]').forEach(btn => {
      btn.addEventListener('click', () => {
        state.textTransform = btn.dataset.transform;
        updatePreview();
        updateControls();
        emitStyleChange();
        log(`Text transform: ${state.textTransform}`);
      });
    });

    // Style toggles
    document.getElementById('toggleItalic').addEventListener('click', () => {
      state.fontStyle = state.fontStyle === 'italic' ? 'normal' : 'italic';
      updatePreview();
      updateControls();
      emitStyleChange();
    });

    document.getElementById('toggleUnderline').addEventListener('click', () => {
      const hasUnderline = state.textDecoration.includes('underline');
      if (hasUnderline) {
        state.textDecoration = state.textDecoration.replace('underline', '').trim() || 'none';
      } else {
        state.textDecoration = state.textDecoration === 'none' ? 'underline' : state.textDecoration + ' underline';
      }
      updatePreview();
      updateControls();
      emitStyleChange();
    });

    document.getElementById('toggleStrike').addEventListener('click', () => {
      const hasStrike = state.textDecoration.includes('line-through');
      if (hasStrike) {
        state.textDecoration = state.textDecoration.replace('line-through', '').trim() || 'none';
      } else {
        state.textDecoration = state.textDecoration === 'none' ? 'line-through' : state.textDecoration + ' line-through';
      }
      updatePreview();
      updateControls();
      emitStyleChange();
    });

    // Preset buttons
    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const preset = presets[btn.dataset.preset];
        if (preset) {
          Object.assign(state, preset);
          updatePreview();
          updateControls();
          emitStyleChange();
          log(`Applied preset: ${btn.dataset.preset}`);
        }
      });
    });

    // Preview text editing
    previewText.addEventListener('input', () => {
      state.text = previewText.innerText;
      updateCharCount();
      emitTextChange();
    });

    previewText.addEventListener('blur', () => {
      if (!previewText.innerText.trim()) {
        previewText.innerText = '';
      }
    });

    // ========================================
    // WIDGET API INTEGRATION
    // ========================================
    function init() {
      if (!window.WidgetAPI) {
        setTimeout(init, 50);
        return;
      }

      log('Initializing Text Styles widget');

      window.WidgetAPI.onEvent('*', (event) => {
        switch (event.type) {
          case 'text.set':
            const text = typeof event.payload === 'string' ? event.payload : event.payload?.text;
            if (text) {
              state.text = text;
              previewText.innerText = text;
              updateCharCount();
            }
            break;

          case 'style.apply':
            if (event.payload) {
              Object.entries(event.payload).forEach(([key, value]) => {
                if (key in state) {
                  state[key] = value;
                }
              });
              updatePreview();
              updateControls();
            }
            break;

          case 'style.preset':
            const presetName = typeof event.payload === 'string' ? event.payload : event.payload?.preset;
            if (presets[presetName]) {
              Object.assign(state, presets[presetName]);
              updatePreview();
              updateControls();
              emitStyleChange();
            }
            break;

          case 'alignment.set':
            const align = typeof event.payload === 'string' ? event.payload : event.payload?.alignment;
            if (['left', 'center', 'right', 'justify'].includes(align)) {
              state.textAlign = align;
              updatePreview();
              updateControls();
            }
            break;

          case 'transform.set':
            const transform = typeof event.payload === 'string' ? event.payload : event.payload?.transform;
            if (['none', 'uppercase', 'lowercase', 'capitalize'].includes(transform)) {
              state.textTransform = transform;
              updatePreview();
              updateControls();
            }
            break;

          case 'style.export':
            emit('style.exported', { ...state });
            break;

          // Listen for brand color changes
          case 'brand:color-changed':
            if (event.payload?.color) {
              state.color = event.payload.color;
              updatePreview();
              updateControls();
              log(`Applied brand color: ${event.payload.color}`);
            }
            break;

          // Listen for brand font changes
          case 'brand:font-changed':
            if (event.payload?.fontFamily) {
              state.fontFamily = event.payload.fontFamily;
              updatePreview();
              updateControls();
              log(`Applied brand font: ${event.payload.fontFamily}`);
            }
            break;
        }
      });

      // Register capabilities
      if (window.WidgetAPI.registerCapabilities) {
        window.WidgetAPI.registerCapabilities({
          canEdit: ['text'],
          canNest: true,
          canBeNested: true
        });
      }

      // Initialize
      updatePreview();
      updateControls();
      updateCharCount();

      emit('widget.ready', { capabilities: ['text', 'typography'] });
      log('Text Styles widget ready');
    }

    init();
  </script>
</body>
</html>
