<!DOCTYPE html>
<html>
<head>
  <style>
    :root {
      --sn-bg-primary: #0f0f19;
      --sn-bg-secondary: #1a1a2e;
      --sn-bg-tertiary: #252538;
      --sn-text-primary: #e2e8f0;
      --sn-text-secondary: #94a3b8;
      --sn-text-muted: #64748b;
      --sn-accent-primary: #8b5cf6;
      --sn-accent-secondary: #a78bfa;
      --sn-border-primary: rgba(139, 92, 246, 0.2);
      --sn-border-hover: rgba(139, 92, 246, 0.4);
      --sn-radius-sm: 4px;
      --sn-radius-md: 6px;
      --sn-transition-fast: 0.15s ease;
      --sn-success: #22c55e;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--sn-bg-primary);
      color: var(--sn-text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Header */
    .header {
      padding: 12px;
      background: var(--sn-bg-tertiary);
      border-bottom: 1px solid var(--sn-border-primary);
    }

    .add-btn {
      width: 100%;
      padding: 10px 16px;
      background: var(--sn-accent-primary);
      border: none;
      border-radius: var(--sn-radius-md);
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all var(--sn-transition-fast);
    }

    .add-btn:hover {
      background: var(--sn-accent-secondary);
      transform: translateY(-1px);
    }

    /* Selection Status */
    .selection-status {
      padding: 8px 12px;
      background: var(--sn-bg-secondary);
      border-bottom: 1px solid var(--sn-border-primary);
      font-size: 11px;
      color: var(--sn-text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .selection-status.has-selection {
      color: var(--sn-success);
    }

    .selection-status .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--sn-text-muted);
    }

    .selection-status.has-selection .dot {
      background: var(--sn-success);
    }

    /* Shape Preview */
    .preview-canvas {
      flex: 0 0 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--sn-bg-tertiary);
      border-bottom: 1px solid var(--sn-border-primary);
    }

    #shapePreview {
      max-width: 100px;
      max-height: 100px;
    }

    /* Shape Picker */
    .shape-picker {
      padding: 12px;
      background: var(--sn-bg-tertiary);
      border-bottom: 1px solid var(--sn-border-primary);
    }

    .shape-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 6px;
    }

    .shape-btn {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--sn-bg-primary);
      border: 2px solid var(--sn-border-primary);
      border-radius: var(--sn-radius-sm);
      cursor: pointer;
      transition: all var(--sn-transition-fast);
      padding: 6px;
    }

    .shape-btn:hover {
      border-color: var(--sn-border-hover);
      transform: scale(1.05);
    }

    .shape-btn.active {
      border-color: var(--sn-accent-primary);
      background: rgba(139, 92, 246, 0.1);
    }

    .shape-btn svg {
      width: 100%;
      height: 100%;
      fill: var(--sn-text-secondary);
    }

    .shape-btn.active svg {
      fill: var(--sn-accent-primary);
    }

    /* Controls Panel */
    .controls-panel {
      flex: 1;
      overflow-y: auto;
      background: var(--sn-bg-secondary);
      padding: 12px;
    }

    .control-section {
      margin-bottom: 16px;
    }

    .section-header {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--sn-text-secondary);
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--sn-border-primary);
    }

    .control-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .control-group {
      flex: 1;
      min-width: 0;
    }

    .control-label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--sn-text-secondary);
      margin-bottom: 4px;
    }

    .control-value {
      color: var(--sn-accent-primary);
      font-weight: 600;
      font-size: 10px;
    }

    /* Inputs */
    input[type="range"] {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      background: var(--sn-bg-primary);
      border-radius: 3px;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background: var(--sn-accent-primary);
      border-radius: 50%;
      cursor: pointer;
    }

    .color-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input[type="color"] {
      width: 36px;
      height: 32px;
      padding: 0;
      border: 2px solid var(--sn-border-primary);
      border-radius: var(--sn-radius-sm);
      cursor: pointer;
      background: none;
    }

    input[type="color"]::-webkit-color-swatch-wrapper { padding: 2px; }
    input[type="color"]::-webkit-color-swatch { border: none; border-radius: 2px; }

    .color-hex {
      flex: 1;
      padding: 8px 10px;
      background: var(--sn-bg-primary);
      border: 1px solid var(--sn-border-primary);
      border-radius: var(--sn-radius-sm);
      color: var(--sn-text-primary);
      font-size: 12px;
      font-family: monospace;
    }

    select {
      width: 100%;
      padding: 8px 10px;
      background: var(--sn-bg-primary);
      border: 1px solid var(--sn-border-primary);
      border-radius: var(--sn-radius-sm);
      color: var(--sn-text-primary);
      font-size: 12px;
      cursor: pointer;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px;
      background: var(--sn-bg-primary);
      border-radius: var(--sn-radius-sm);
      margin-bottom: 8px;
    }

    .toggle-label {
      font-size: 11px;
      color: var(--sn-text-secondary);
    }

    .toggle-switch {
      position: relative;
      width: 36px;
      height: 20px;
      background: var(--sn-bg-tertiary);
      border-radius: 10px;
      cursor: pointer;
      transition: all var(--sn-transition-fast);
    }

    .toggle-switch.active { background: var(--sn-accent-primary); }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 50%;
      transition: all var(--sn-transition-fast);
    }

    .toggle-switch.active::after { left: 18px; }

    /* Color Presets */
    .color-presets {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .color-preset {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all var(--sn-transition-fast);
    }

    .color-preset:hover { transform: scale(1.1); }
    .color-preset.active { border-color: white; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--sn-bg-primary); }
    ::-webkit-scrollbar-thumb { background: var(--sn-bg-tertiary); border-radius: 3px; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <button class="add-btn" id="addShapeBtn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
      </svg>
      Add Shape to Canvas
    </button>
  </div>

  <!-- Selection Status -->
  <div class="selection-status" id="selectionStatus">
    <span class="dot"></span>
    <span id="statusText">No shape selected</span>
  </div>

  <!-- Preview -->
  <div class="preview-canvas">
    <svg id="shapePreview" viewBox="0 0 100 100" width="80" height="80">
      <defs>
        <linearGradient id="shapeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#8b5cf6"/>
          <stop offset="100%" stop-color="#ec4899"/>
        </linearGradient>
      </defs>
      <rect id="shapeElement" x="10" y="10" width="80" height="80" rx="0" fill="#8b5cf6"/>
    </svg>
  </div>

  <!-- Shape Picker -->
  <div class="shape-picker">
    <div class="shape-grid">
      <button class="shape-btn active" data-shape="rect" title="Rectangle">
        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="0"/></svg>
      </button>
      <button class="shape-btn" data-shape="roundedRect" title="Rounded Rectangle">
        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="4"/></svg>
      </button>
      <button class="shape-btn" data-shape="circle" title="Circle">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/></svg>
      </button>
      <button class="shape-btn" data-shape="ellipse" title="Ellipse">
        <svg viewBox="0 0 24 24"><ellipse cx="12" cy="12" rx="10" ry="6"/></svg>
      </button>
      <button class="shape-btn" data-shape="triangle" title="Triangle">
        <svg viewBox="0 0 24 24"><polygon points="12,3 22,21 2,21"/></svg>
      </button>
      <button class="shape-btn" data-shape="hexagon" title="Hexagon">
        <svg viewBox="0 0 24 24"><polygon points="12,2 21,7 21,17 12,22 3,17 3,7"/></svg>
      </button>
      <button class="shape-btn" data-shape="star" title="Star">
        <svg viewBox="0 0 24 24"><polygon points="12,2 15,9 22,9 17,14 19,21 12,17 5,21 7,14 2,9 9,9"/></svg>
      </button>
      <button class="shape-btn" data-shape="heart" title="Heart">
        <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
      </button>
      <button class="shape-btn" data-shape="diamond" title="Diamond">
        <svg viewBox="0 0 24 24"><polygon points="12,2 22,12 12,22 2,12"/></svg>
      </button>
      <button class="shape-btn" data-shape="arrow" title="Arrow">
        <svg viewBox="0 0 24 24"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8-8-8z"/></svg>
      </button>
      <button class="shape-btn" data-shape="pentagon" title="Pentagon">
        <svg viewBox="0 0 24 24"><polygon points="12,2 22,9 18,21 6,21 2,9"/></svg>
      </button>
      <button class="shape-btn" data-shape="octagon" title="Octagon">
        <svg viewBox="0 0 24 24"><polygon points="7,2 17,2 22,7 22,17 17,22 7,22 2,17 2,7"/></svg>
      </button>
    </div>
  </div>

  <!-- Controls Panel -->
  <div class="controls-panel">
    <!-- Fill -->
    <div class="control-section">
      <div class="section-header">Fill</div>
      <div class="toggle-row">
        <span class="toggle-label">Enable Fill</span>
        <div class="toggle-switch active" id="fillEnabled"></div>
      </div>
      <div class="control-row">
        <div class="control-group">
          <div class="control-label"><span>Fill Color</span></div>
          <div class="color-row">
            <input type="color" id="fillColor" value="#8b5cf6">
            <input type="text" class="color-hex" id="fillHex" value="#8B5CF6">
          </div>
        </div>
      </div>
      <div class="color-presets">
        <div class="color-preset active" style="background: #8b5cf6" data-color="#8b5cf6"></div>
        <div class="color-preset" style="background: #ec4899" data-color="#ec4899"></div>
        <div class="color-preset" style="background: #06b6d4" data-color="#06b6d4"></div>
        <div class="color-preset" style="background: #22c55e" data-color="#22c55e"></div>
        <div class="color-preset" style="background: #f97316" data-color="#f97316"></div>
        <div class="color-preset" style="background: #ef4444" data-color="#ef4444"></div>
        <div class="color-preset" style="background: #fbbf24" data-color="#fbbf24"></div>
        <div class="color-preset" style="background: #e2e8f0" data-color="#e2e8f0"></div>
      </div>
    </div>

    <!-- Stroke -->
    <div class="control-section">
      <div class="section-header">Stroke</div>
      <div class="toggle-row">
        <span class="toggle-label">Enable Stroke</span>
        <div class="toggle-switch" id="strokeEnabled"></div>
      </div>
      <div class="control-row">
        <div class="control-group">
          <div class="control-label">
            <span>Stroke Width</span>
            <span class="control-value" id="strokeWidthValue">0px</span>
          </div>
          <input type="range" id="strokeWidth" min="0" max="20" value="0">
        </div>
      </div>
      <div class="control-row">
        <div class="control-group">
          <div class="control-label"><span>Stroke Color</span></div>
          <div class="color-row">
            <input type="color" id="strokeColor" value="#6d28d9">
            <input type="text" class="color-hex" id="strokeHex" value="#6D28D9">
          </div>
        </div>
      </div>
    </div>

    <!-- Corner Radius -->
    <div class="control-section" id="radiusSection">
      <div class="section-header">Corner Radius</div>
      <div class="control-row">
        <div class="control-group">
          <div class="control-label">
            <span>Radius</span>
            <span class="control-value" id="radiusValue">0px</span>
          </div>
          <input type="range" id="cornerRadius" min="0" max="50" value="0">
        </div>
      </div>
    </div>

    <!-- Opacity -->
    <div class="control-section">
      <div class="section-header">Opacity</div>
      <div class="control-row">
        <div class="control-group">
          <div class="control-label">
            <span>Opacity</span>
            <span class="control-value" id="opacityValue">100%</span>
          </div>
          <input type="range" id="opacity" min="0" max="100" value="100">
        </div>
      </div>
    </div>

    <!-- Shadow -->
    <div class="control-section">
      <div class="section-header">Shadow</div>
      <div class="toggle-row">
        <span class="toggle-label">Enable Shadow</span>
        <div class="toggle-switch" id="shadowEnabled"></div>
      </div>
      <div class="control-row">
        <div class="control-group">
          <div class="control-label">
            <span>Blur</span>
            <span class="control-value" id="shadowBlurValue">4px</span>
          </div>
          <input type="range" id="shadowBlur" min="0" max="30" value="4">
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========================================
    // STATE
    // ========================================
    const state = {
      shape: 'rect',
      fill: { enabled: true, color: '#8b5cf6' },
      stroke: { enabled: false, color: '#6d28d9', width: 0 },
      cornerRadius: 0,
      opacity: 100,
      shadow: { enabled: false, blur: 4, color: '#000000' },
      selectedWidgetId: null,
    };

    // Shape paths
    const shapePaths = {
      rect: () => `<rect x="10" y="10" width="80" height="80" rx="${state.cornerRadius}"/>`,
      roundedRect: () => `<rect x="10" y="10" width="80" height="80" rx="${Math.max(state.cornerRadius, 10)}"/>`,
      circle: () => `<circle cx="50" cy="50" r="40"/>`,
      ellipse: () => `<ellipse cx="50" cy="50" rx="40" ry="25"/>`,
      triangle: () => `<polygon points="50,10 90,90 10,90"/>`,
      pentagon: () => createPolygon(5, 40, 50, 50),
      hexagon: () => createPolygon(6, 40, 50, 50),
      octagon: () => createPolygon(8, 40, 50, 50),
      star: () => createStar(5, 40, 20, 50, 50),
      heart: () => `<path d="M50 85 C50 85 15 60 15 35 C15 15 35 5 50 25 C65 5 85 15 85 35 C85 60 50 85 50 85 Z"/>`,
      diamond: () => `<polygon points="50,10 90,50 50,90 10,50"/>`,
      arrow: () => `<path d="M20 50 L70 50 L70 35 L90 50 L70 65 L70 50"/>`,
    };

    function createPolygon(sides, radius, cx, cy) {
      const points = [];
      for (let i = 0; i < sides; i++) {
        const angle = (i * 2 * Math.PI / sides) - Math.PI / 2;
        const x = cx + radius * Math.cos(angle);
        const y = cy + radius * Math.sin(angle);
        points.push(`${x},${y}`);
      }
      return `<polygon points="${points.join(' ')}"/>`;
    }

    function createStar(pts, outerR, innerR, cx, cy) {
      const points = [];
      for (let i = 0; i < pts * 2; i++) {
        const r = i % 2 === 0 ? outerR : innerR;
        const angle = (i * Math.PI / pts) - Math.PI / 2;
        const x = cx + r * Math.cos(angle);
        const y = cy + r * Math.sin(angle);
        points.push(`${x},${y}`);
      }
      return `<polygon points="${points.join(' ')}"/>`;
    }

    // ========================================
    // HELPERS
    // ========================================
    function emit(type, payload) {
      if (window.WidgetAPI) {
        window.WidgetAPI.emitEvent({ type, scope: 'canvas', payload });
      }
    }

    function broadcast(type, payload) {
      if (window.WidgetAPI) {
        window.WidgetAPI.emitEvent({ type, scope: 'canvas', payload, broadcast: true });
      }
    }

    function log(msg) {
      console.log('[ShapeTool]', msg);
      if (window.WidgetAPI) window.WidgetAPI.log(msg);
    }

    function renderPreview() {
      const svg = document.getElementById('shapePreview');
      const path = shapePaths[state.shape] ? shapePaths[state.shape]() : shapePaths.rect();

      let fill = state.fill.enabled ? state.fill.color : 'none';
      let stroke = state.stroke.enabled ? state.stroke.color : 'none';
      let strokeWidth = state.stroke.enabled ? state.stroke.width : 0;
      let opacity = state.opacity / 100;
      let filter = state.shadow.enabled ? 'url(#shadowFilter)' : 'none';

      svg.innerHTML = `
        <defs>
          <filter id="shadowFilter" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="2" dy="2" stdDeviation="${state.shadow.blur}" flood-color="${state.shadow.color}80"/>
          </filter>
        </defs>
        <g fill="${fill}" stroke="${stroke}" stroke-width="${strokeWidth}" opacity="${opacity}" filter="${filter}">
          ${path}
        </g>
      `;
    }

    function updateUI() {
      document.querySelectorAll('.shape-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`[data-shape="${state.shape}"]`)?.classList.add('active');

      document.getElementById('fillEnabled').classList.toggle('active', state.fill.enabled);
      document.getElementById('strokeEnabled').classList.toggle('active', state.stroke.enabled);
      document.getElementById('shadowEnabled').classList.toggle('active', state.shadow.enabled);

      document.getElementById('fillColor').value = state.fill.color;
      document.getElementById('fillHex').value = state.fill.color.toUpperCase();
      document.getElementById('strokeColor').value = state.stroke.color;
      document.getElementById('strokeHex').value = state.stroke.color.toUpperCase();
      document.getElementById('strokeWidth').value = state.stroke.width;
      document.getElementById('cornerRadius').value = state.cornerRadius;
      document.getElementById('opacity').value = state.opacity;
      document.getElementById('shadowBlur').value = state.shadow.blur;

      document.getElementById('strokeWidthValue').textContent = `${state.stroke.width}px`;
      document.getElementById('radiusValue').textContent = `${state.cornerRadius}px`;
      document.getElementById('opacityValue').textContent = `${state.opacity}%`;
      document.getElementById('shadowBlurValue').textContent = `${state.shadow.blur}px`;

      // Show/hide corner radius for rect shapes only
      document.getElementById('radiusSection').style.display =
        ['rect', 'roundedRect'].includes(state.shape) ? 'block' : 'none';

      // Color presets
      document.querySelectorAll('.color-preset').forEach(p => {
        p.classList.toggle('active', p.dataset.color === state.fill.color);
      });

      renderPreview();
    }

    function updateSelectionStatus() {
      const status = document.getElementById('selectionStatus');
      const text = document.getElementById('statusText');
      if (state.selectedWidgetId) {
        status.classList.add('has-selection');
        text.textContent = `Editing: ${state.selectedWidgetId.slice(0, 12)}...`;
      } else {
        status.classList.remove('has-selection');
        text.textContent = 'No shape selected';
      }
    }

    function emitStyleChange() {
      const styleData = {
        shape: state.shape,
        fill: { ...state.fill },
        stroke: { ...state.stroke },
        cornerRadius: state.cornerRadius,
        opacity: state.opacity,
        shadow: { ...state.shadow },
      };

      broadcast('canvas:style-changed', {
        targetType: 'shape',
        targetId: state.selectedWidgetId,
        styles: styleData
      });

      emit('shape.style-changed', styleData);
    }

    // ========================================
    // EVENT HANDLERS
    // ========================================

    // Add Shape
    document.getElementById('addShapeBtn').addEventListener('click', () => {
      const svg = document.getElementById('shapePreview').innerHTML;
      broadcast('canvas:add-shape', {
        type: state.shape,
        svg: svg,
        ...state.fill,
        ...state.stroke,
        cornerRadius: state.cornerRadius,
        opacity: state.opacity,
        shadow: state.shadow,
      });
      log('Added shape to canvas');
    });

    // Shape picker
    document.querySelectorAll('.shape-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        state.shape = btn.dataset.shape;
        updateUI();
        emitStyleChange();
      });
    });

    // Toggles
    document.getElementById('fillEnabled').addEventListener('click', function() {
      this.classList.toggle('active');
      state.fill.enabled = this.classList.contains('active');
      updateUI();
      emitStyleChange();
    });

    document.getElementById('strokeEnabled').addEventListener('click', function() {
      this.classList.toggle('active');
      state.stroke.enabled = this.classList.contains('active');
      updateUI();
      emitStyleChange();
    });

    document.getElementById('shadowEnabled').addEventListener('click', function() {
      this.classList.toggle('active');
      state.shadow.enabled = this.classList.contains('active');
      updateUI();
      emitStyleChange();
    });

    // Colors
    document.getElementById('fillColor').addEventListener('input', (e) => {
      state.fill.color = e.target.value;
      document.getElementById('fillHex').value = e.target.value.toUpperCase();
      updateUI();
      emitStyleChange();
    });

    document.getElementById('fillHex').addEventListener('input', (e) => {
      let hex = e.target.value;
      if (!hex.startsWith('#')) hex = '#' + hex;
      if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
        state.fill.color = hex;
        document.getElementById('fillColor').value = hex;
        updateUI();
        emitStyleChange();
      }
    });

    document.getElementById('strokeColor').addEventListener('input', (e) => {
      state.stroke.color = e.target.value;
      document.getElementById('strokeHex').value = e.target.value.toUpperCase();
      updateUI();
      emitStyleChange();
    });

    document.getElementById('strokeHex').addEventListener('input', (e) => {
      let hex = e.target.value;
      if (!hex.startsWith('#')) hex = '#' + hex;
      if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
        state.stroke.color = hex;
        document.getElementById('strokeColor').value = hex;
        updateUI();
        emitStyleChange();
      }
    });

    // Sliders
    document.getElementById('strokeWidth').addEventListener('input', (e) => {
      state.stroke.width = parseInt(e.target.value);
      document.getElementById('strokeWidthValue').textContent = `${state.stroke.width}px`;
      updateUI();
      emitStyleChange();
    });

    document.getElementById('cornerRadius').addEventListener('input', (e) => {
      state.cornerRadius = parseInt(e.target.value);
      document.getElementById('radiusValue').textContent = `${state.cornerRadius}px`;
      updateUI();
      emitStyleChange();
    });

    document.getElementById('opacity').addEventListener('input', (e) => {
      state.opacity = parseInt(e.target.value);
      document.getElementById('opacityValue').textContent = `${state.opacity}%`;
      updateUI();
      emitStyleChange();
    });

    document.getElementById('shadowBlur').addEventListener('input', (e) => {
      state.shadow.blur = parseInt(e.target.value);
      document.getElementById('shadowBlurValue').textContent = `${state.shadow.blur}px`;
      updateUI();
      emitStyleChange();
    });

    // Color presets
    document.querySelectorAll('.color-preset').forEach(preset => {
      preset.addEventListener('click', () => {
        state.fill.color = preset.dataset.color;
        updateUI();
        emitStyleChange();
      });
    });

    // ========================================
    // WIDGET API
    // ========================================
    function init() {
      if (!window.WidgetAPI) {
        setTimeout(init, 50);
        return;
      }

      log('Initializing Shape Tool');

      window.WidgetAPI.onEvent('*', (event) => {
        switch (event.type) {
          case 'widget:selected':
          case 'entity:selected':
            if (event.payload?.entityType === 'shape' || event.payload?.type === 'shape') {
              state.selectedWidgetId = event.payload.widgetInstanceId || event.payload.id;
              if (event.payload.styles) {
                if (event.payload.styles.fill) state.fill = { ...state.fill, ...event.payload.styles.fill };
                if (event.payload.styles.stroke) state.stroke = { ...state.stroke, ...event.payload.styles.stroke };
                if (event.payload.styles.cornerRadius !== undefined) state.cornerRadius = event.payload.styles.cornerRadius;
                if (event.payload.styles.opacity !== undefined) state.opacity = event.payload.styles.opacity;
                if (event.payload.styles.shadow) state.shadow = { ...state.shadow, ...event.payload.styles.shadow };
                if (event.payload.styles.shape) state.shape = event.payload.styles.shape;
              }
              updateUI();
              updateSelectionStatus();
            }
            break;

          case 'widget:deselected':
          case 'selection:cleared':
            state.selectedWidgetId = null;
            updateSelectionStatus();
            break;

          case 'brand:color-changed':
            if (event.payload?.color) {
              state.fill.color = event.payload.color;
              updateUI();
              emitStyleChange();
            }
            break;
        }
      });

      if (window.WidgetAPI.registerCapabilities) {
        window.WidgetAPI.registerCapabilities({
          canEdit: ['shape', 'vector'],
          canCreate: ['shape'],
          isDesignTool: true,
        });
      }

      updateUI();
      updateSelectionStatus();
      emit('widget.ready', { capabilities: ['shapes', 'vector', 'design-tool'] });
      log('Shape Tool ready');
    }

    init();
  </script>
</body>
</html>
