<!DOCTYPE html>
<html>
<head>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 10px;
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #8B4513 0%, #654321 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h3 {
            margin: 0 0 10px 0;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            font-size: 14px;
        }
        .plot {
            width: 100%;
            max-width: 200px;
            aspect-ratio: 1;
            background: #5D4E37;
            border: 4px solid #3D2914;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .plot:hover { transform: scale(1.02); }
        .plot.watered { background: #4A3C2A; }
        .progress-bar {
            position: absolute;
            bottom: 5px;
            left: 5px;
            right: 5px;
            height: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #4ade80);
            transition: width 0.5s;
        }
        .status {
            color: #fff;
            font-size: 11px;
            margin-top: 8px;
            text-align: center;
            opacity: 0.9;
        }
        .controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }
        .water-btn { background: #3b82f6; color: white; }
        .harvest-btn { background: #22c55e; color: white; }
        .harvest-btn:disabled { background: #666; cursor: not-allowed; }
    </style>
</head>
<body>
    <h3>Crop Plot</h3>
    <div class="plot" id="plot">
        <span id="cropEmoji">ðŸŸ«</span>
        <div class="progress-bar">
            <div class="progress-fill" id="progress" style="width: 0%"></div>
        </div>
    </div>
    <div class="status" id="status">Empty - waiting for seeds</div>
    <div class="controls">
        <button class="water-btn" onclick="waterPlot()">ðŸ’§ Water</button>
        <button class="harvest-btn" id="harvestBtn" onclick="harvest()" disabled>ðŸŒ¾ Harvest</button>
    </div>

    <script>
        const CROPS = {
            tomato: { emoji: 'ðŸ…', stages: ['ðŸŒ±', 'ðŸŒ¿', 'ðŸª´', 'ðŸ…'], growTime: 8000 },
            carrot: { emoji: 'ðŸ¥•', stages: ['ðŸŒ±', 'ðŸŒ¿', 'ðŸ¥•', 'ðŸ¥•'], growTime: 6000 },
            corn: { emoji: 'ðŸŒ½', stages: ['ðŸŒ±', 'ðŸŒ¾', 'ðŸŒ½', 'ðŸŒ½'], growTime: 10000 },
            wheat: { emoji: 'ðŸŒ¾', stages: ['ðŸŒ±', 'ðŸŒ¿', 'ðŸŒ¾', 'ðŸŒ¾'], growTime: 5000 },
            strawberry: { emoji: 'ðŸ“', stages: ['ðŸŒ±', 'ðŸŒ¸', 'ðŸ«', 'ðŸ“'], growTime: 7000 }
        };

        let state = {
            planted: null,
            growth: 0,
            watered: false,
            weatherBonus: 1,
            lastWatered: 0
        };

        let growInterval = null;

        function updateDisplay() {
            const plot = document.getElementById('plot');
            const emoji = document.getElementById('cropEmoji');
            const progress = document.getElementById('progress');
            const status = document.getElementById('status');
            const harvestBtn = document.getElementById('harvestBtn');

            plot.classList.toggle('watered', state.watered);

            if (!state.planted) {
                emoji.textContent = 'ðŸŸ«';
                progress.style.width = '0%';
                status.textContent = 'Empty - waiting for seeds';
                harvestBtn.disabled = true;
                return;
            }

            const crop = CROPS[state.planted];
            const stageIndex = Math.min(Math.floor(state.growth / 25), 3);
            emoji.textContent = crop.stages[stageIndex];
            progress.style.width = state.growth + '%';

            if (state.growth >= 100) {
                status.textContent = `${crop.emoji} Ready to harvest!`;
                harvestBtn.disabled = false;
            } else {
                status.textContent = `Growing ${state.planted}... ${Math.floor(state.growth)}%`;
                if (state.watered) status.textContent += ' ðŸ’§';
                harvestBtn.disabled = true;
            }

            emitStatus();
        }

        function plantSeed(seedType) {
            if (state.planted) {
                console.log('Plot already has a crop!');
                return;
            }
            if (!CROPS[seedType]) {
                console.log('Unknown seed type:', seedType);
                return;
            }

            state.planted = seedType;
            state.growth = 0;
            state.watered = false;
            updateDisplay();
            startGrowing();
        }

        function startGrowing() {
            if (growInterval) clearInterval(growInterval);

            const crop = CROPS[state.planted];
            const baseGrowth = 100 / (crop.growTime / 500);

            growInterval = setInterval(() => {
                if (state.growth >= 100) {
                    clearInterval(growInterval);
                    return;
                }

                let growthRate = baseGrowth * state.weatherBonus;
                if (state.watered) growthRate *= 1.5;

                state.growth = Math.min(100, state.growth + growthRate);

                // Water dries up over time
                if (state.watered && Date.now() - state.lastWatered > 3000) {
                    state.watered = false;
                }

                updateDisplay();
            }, 500);
        }

        function waterPlot() {
            if (!state.planted) return;
            state.watered = true;
            state.lastWatered = Date.now();
            updateDisplay();
        }

        function harvest() {
            if (!state.planted || state.growth < 100) return;

            const crop = CROPS[state.planted];
            const harvestData = {
                crop: state.planted,
                emoji: crop.emoji,
                quality: state.watered ? 'excellent' : 'good',
                timestamp: Date.now()
            };

            // Emit harvest event
            window.parent.postMessage({
                type: 'widget:emit',
                payload: {
                    type: 'farm:harvest',
                    payload: harvestData
                }
            }, '*');

            // Reset plot
            if (growInterval) clearInterval(growInterval);
            state = { planted: null, growth: 0, watered: false, weatherBonus: 1, lastWatered: 0 };
            updateDisplay();
        }

        function emitStatus() {
            window.parent.postMessage({
                type: 'widget:emit',
                payload: {
                    type: 'farm:plot-status',
                    payload: {
                        planted: state.planted,
                        growth: state.growth,
                        watered: state.watered,
                        ready: state.growth >= 100
                    }
                }
            }, '*');
        }

        // Listen for messages from parent
        window.addEventListener('message', (event) => {
            const { type, payload } = event.data || {};

            if (type === 'EVENT') {
                const eventType = payload?.type;
                const eventData = payload?.payload;

                if (eventType === 'farm:plant-seed' && eventData?.seedType) {
                    plantSeed(eventData.seedType);
                }
                if (eventType === 'farm:water') {
                    waterPlot();
                }
                if (eventType === 'farm:weather') {
                    state.weatherBonus = eventData?.sunny ? 1.3 : (eventData?.rainy ? 0.8 : 1);
                    if (eventData?.rainy) {
                        state.watered = true;
                        state.lastWatered = Date.now();
                    }
                }
            }
        });

        // Send ready message
        window.parent.postMessage({ type: 'READY' }, '*');
        updateDisplay();
    </script>
</body>
</html>
