<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube Playlist Widget</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--widget-bg, #1a1a2e);
      color: var(--widget-text, #e0e0e0);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: var(--widget-header-bg, #16213e);
      border-bottom: 1px solid var(--widget-border, #0f3460);
    }

    .header h1 {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .header-icon {
      width: 18px;
      height: 18px;
      fill: #ff0000;
    }

    .playlist-selector {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .playlist-selector select {
      background: var(--widget-input-bg, #0f3460);
      color: var(--widget-text, #e0e0e0);
      border: 1px solid var(--widget-border, #1a4080);
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      max-width: 140px;
    }

    .btn {
      background: var(--widget-btn-bg, #0f3460);
      color: var(--widget-text, #e0e0e0);
      border: 1px solid var(--widget-border, #1a4080);
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover {
      background: var(--widget-btn-hover, #1a4080);
    }

    .btn.primary {
      background: #e94560;
      border-color: #e94560;
    }

    .btn.primary:hover {
      background: #ff6b6b;
    }

    .btn-icon {
      padding: 4px 6px;
      font-size: 14px;
    }

    .player-section {
      position: relative;
      background: #000;
      aspect-ratio: 16/9;
      flex-shrink: 0;
    }

    .player-section iframe {
      width: 100%;
      height: 100%;
    }

    .player-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #666;
      gap: 8px;
    }

    .player-placeholder svg {
      width: 48px;
      height: 48px;
      opacity: 0.5;
    }

    .controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px;
      background: var(--widget-header-bg, #16213e);
      border-bottom: 1px solid var(--widget-border, #0f3460);
    }

    .control-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .control-btn.play {
      width: 44px;
      height: 44px;
      font-size: 20px;
      background: #e94560;
      border-color: #e94560;
    }

    .control-btn.play:hover {
      background: #ff6b6b;
    }

    .control-btn svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    .control-btn.play svg {
      width: 22px;
      height: 22px;
    }

    .shuffle-btn.active {
      background: #e94560;
      border-color: #e94560;
    }

    .progress-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 12px 8px;
      background: var(--widget-header-bg, #16213e);
      font-size: 11px;
      color: #888;
    }

    .progress-track {
      flex: 1;
      height: 4px;
      background: var(--widget-border, #0f3460);
      border-radius: 2px;
      cursor: pointer;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: #e94560;
      border-radius: 2px;
      transition: width 0.1s;
    }

    .add-video-section {
      display: flex;
      gap: 6px;
      padding: 8px 12px;
      background: var(--widget-bg, #1a1a2e);
      border-bottom: 1px solid var(--widget-border, #0f3460);
    }

    .add-video-section input {
      flex: 1;
      background: var(--widget-input-bg, #0f3460);
      color: var(--widget-text, #e0e0e0);
      border: 1px solid var(--widget-border, #1a4080);
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 12px;
    }

    .add-video-section input::placeholder {
      color: #666;
    }

    .playlist-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .video-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      background: var(--widget-header-bg, #16213e);
      border-radius: 6px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .video-item:hover {
      background: var(--widget-btn-hover, #1a4080);
    }

    .video-item.active {
      border-color: #e94560;
      background: rgba(233, 69, 96, 0.1);
    }

    .video-thumb {
      width: 80px;
      height: 45px;
      border-radius: 4px;
      object-fit: cover;
      background: #000;
      flex-shrink: 0;
    }

    .video-info {
      flex: 1;
      min-width: 0;
    }

    .video-title {
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
    }

    .video-meta {
      font-size: 10px;
      color: #888;
    }

    .video-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .video-item:hover .video-actions {
      opacity: 1;
    }

    .video-actions .btn {
      padding: 2px 6px;
      font-size: 10px;
    }

    .empty-playlist {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .empty-playlist svg {
      width: 48px;
      height: 48px;
      opacity: 0.3;
      margin-bottom: 12px;
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--widget-bg, #1a1a2e);
      border: 1px solid var(--widget-border, #0f3460);
      border-radius: 8px;
      padding: 16px;
      min-width: 280px;
    }

    .modal-content h3 {
      font-size: 14px;
      margin-bottom: 12px;
    }

    .modal-content input {
      width: 100%;
      background: var(--widget-input-bg, #0f3460);
      color: var(--widget-text, #e0e0e0);
      border: 1px solid var(--widget-border, #1a4080);
      border-radius: 4px;
      padding: 8px 10px;
      font-size: 12px;
      margin-bottom: 12px;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .now-playing {
      font-size: 11px;
      color: #888;
      padding: 4px 12px;
      background: var(--widget-header-bg, #16213e);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .now-playing span {
      color: #e94560;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--widget-bg, #1a1a2e);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--widget-border, #0f3460);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--widget-btn-hover, #1a4080);
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>
      <svg class="header-icon" viewBox="0 0 24 24">
        <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
      </svg>
      Playlist
    </h1>
    <div class="playlist-selector">
      <select id="playlistSelect"></select>
      <button class="btn btn-icon" id="addPlaylistBtn" title="New Playlist">+</button>
      <button class="btn btn-icon" id="deletePlaylistBtn" title="Delete Playlist">ðŸ—‘</button>
    </div>
  </div>

  <div class="player-section">
    <div id="player"></div>
    <div class="player-placeholder" id="playerPlaceholder">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814z"/>
        <path d="M9.545 15.568V8.432L15.818 12l-6.273 3.568z" fill="#fff"/>
      </svg>
      <span>Add videos to get started</span>
    </div>
  </div>

  <div class="now-playing" id="nowPlaying">
    No video selected
  </div>

  <div class="controls">
    <button class="btn control-btn shuffle-btn" id="shuffleBtn" title="Shuffle">
      <svg viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
    </button>
    <button class="btn control-btn" id="prevBtn" title="Previous">
      <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
    </button>
    <button class="btn control-btn play" id="playBtn" title="Play">
      <svg viewBox="0 0 24 24" id="playIcon"><path d="M8 5v14l11-7z"/></svg>
    </button>
    <button class="btn control-btn" id="nextBtn" title="Next">
      <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
    </button>
    <button class="btn control-btn" id="volumeBtn" title="Volume">
      <svg viewBox="0 0 24 24" id="volumeIcon"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
    </button>
  </div>

  <div class="progress-bar">
    <span id="currentTime">0:00</span>
    <div class="progress-track" id="progressTrack">
      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>
    <span id="duration">0:00</span>
  </div>

  <div class="add-video-section">
    <input type="text" id="videoUrlInput" placeholder="Paste YouTube URL or video ID...">
    <button class="btn primary" id="addVideoBtn">Add</button>
  </div>

  <div class="playlist-content" id="playlistContent">
    <div class="empty-playlist" id="emptyState">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8 12.5v-9l6 4.5-6 4.5z"/>
      </svg>
      <p>Your playlist is empty</p>
      <p style="font-size: 11px">Paste a YouTube URL above to add videos</p>
    </div>
  </div>

  <!-- New Playlist Modal -->
  <div class="modal" id="newPlaylistModal">
    <div class="modal-content">
      <h3>Create New Playlist</h3>
      <input type="text" id="newPlaylistName" placeholder="Playlist name...">
      <div class="modal-actions">
        <button class="btn" id="cancelNewPlaylist">Cancel</button>
        <button class="btn primary" id="confirmNewPlaylist">Create</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Widget Communication =====
    function emit(portId, payload) {
      // Emit via legacy widget:emit protocol
      window.parent.postMessage({
        type: 'widget:emit',
        payload: { type: portId, payload }
      }, '*');
      // Also emit via EVENT protocol for canvas-wide event broadcasting
      window.parent.postMessage({
        type: 'EVENT',
        payload: { type: portId, scope: 'canvas', payload: payload }
      }, '*');
    }

    function emitEvent(eventType, payload) {
      window.parent.postMessage({
        type: 'EVENT',
        payload: { type: eventType, scope: 'canvas', payload: payload }
      }, '*');
    }

    // ===== State =====
    let playlists = [];
    let currentPlaylistId = null;
    let currentVideoIndex = -1;
    let isPlaying = false;
    let isShuffled = false;
    let shuffledOrder = [];
    let player = null;
    let playerReady = false;
    let volume = 80;

    // ===== YouTube IFrame API =====
    function loadYouTubeAPI() {
      if (window.YT) {
        onYouTubeIframeAPIReady();
        return;
      }
      const tag = document.createElement('script');
      tag.src = 'https://www.youtube.com/iframe_api';
      const firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }

    window.onYouTubeIframeAPIReady = function() {
      player = new YT.Player('player', {
        height: '100%',
        width: '100%',
        playerVars: {
          autoplay: 0,
          controls: 0,
          modestbranding: 1,
          rel: 0,
          showinfo: 0
        },
        events: {
          onReady: onPlayerReady,
          onStateChange: onPlayerStateChange,
          onError: onPlayerError
        }
      });
    };

    function onPlayerReady(event) {
      playerReady = true;
      player.setVolume(volume);
      document.getElementById('playerPlaceholder').style.display = 'none';
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.ENDED) {
        playNext();
      } else if (event.data === YT.PlayerState.PLAYING) {
        isPlaying = true;
        updatePlayButton();
        emitPlayState();
        emitPreview();
      } else if (event.data === YT.PlayerState.PAUSED) {
        isPlaying = false;
        updatePlayButton();
        emitPlayState();
      }
    }

    function onPlayerError(event) {
      console.error('YouTube Player Error:', event.data);
      // Skip to next video on error
      setTimeout(() => playNext(), 1000);
    }

    // ===== Time Update =====
    setInterval(() => {
      if (player && playerReady && isPlaying) {
        const currentTime = player.getCurrentTime() || 0;
        const duration = player.getDuration() || 0;
        const progress = duration > 0 ? (currentTime / duration) * 100 : 0;

        document.getElementById('currentTime').textContent = formatTime(currentTime);
        document.getElementById('duration').textContent = formatTime(duration);
        document.getElementById('progressFill').style.width = progress + '%';

        emit('timeUpdate', { currentTime, duration, progress });
      }
    }, 1000);

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // ===== Playlist Management =====
    function createPlaylist(name) {
      const playlist = {
        id: 'pl_' + Date.now(),
        name: name || 'New Playlist',
        videos: []
      };
      playlists.push(playlist);
      savePlaylists();
      renderPlaylistSelector();
      selectPlaylist(playlist.id);
      emit('playlistChanged', { playlistId: playlist.id, videos: playlist.videos });
      return playlist;
    }

    function deletePlaylist(playlistId) {
      const index = playlists.findIndex(p => p.id === playlistId);
      if (index !== -1) {
        playlists.splice(index, 1);
        savePlaylists();
        renderPlaylistSelector();
        if (playlists.length > 0) {
          selectPlaylist(playlists[0].id);
        } else {
          currentPlaylistId = null;
          currentVideoIndex = -1;
          renderPlaylist();
        }
      }
    }

    function selectPlaylist(playlistId) {
      currentPlaylistId = playlistId;
      currentVideoIndex = -1;
      document.getElementById('playlistSelect').value = playlistId;
      generateShuffledOrder();
      renderPlaylist();
      savePlaylists();
    }

    function getCurrentPlaylist() {
      return playlists.find(p => p.id === currentPlaylistId);
    }

    // ===== Video Management =====
    function extractVideoId(input) {
      if (!input) return null;

      // Direct video ID (11 characters)
      if (/^[a-zA-Z0-9_-]{11}$/.test(input)) {
        return input;
      }

      // YouTube URL patterns
      const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
        /youtube\.com\/shorts\/([a-zA-Z0-9_-]{11})/
      ];

      for (const pattern of patterns) {
        const match = input.match(pattern);
        if (match) return match[1];
      }

      return null;
    }

    async function addVideo(url, title = null, playlistId = null) {
      const videoId = extractVideoId(url);
      if (!videoId) {
        console.error('Invalid YouTube URL or video ID');
        return;
      }

      const targetPlaylistId = playlistId || currentPlaylistId;
      let playlist = playlists.find(p => p.id === targetPlaylistId);

      if (!playlist) {
        playlist = createPlaylist('My Playlist');
      }

      // Check for duplicates
      if (playlist.videos.some(v => v.videoId === videoId)) {
        console.log('Video already in playlist');
        return;
      }

      const video = {
        id: 'v_' + Date.now(),
        videoId: videoId,
        title: title || `Video ${playlist.videos.length + 1}`,
        thumbnail: `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`,
        addedAt: Date.now()
      };

      // Try to fetch video title from oEmbed
      try {
        const response = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${videoId}`);
        const data = await response.json();
        if (data.title) {
          video.title = data.title;
        }
      } catch (e) {
        console.log('Could not fetch video title');
      }

      playlist.videos.push(video);
      savePlaylists();
      generateShuffledOrder();
      renderPlaylist();

      emit('playlistChanged', { playlistId: playlist.id, videos: playlist.videos });

      // Auto-play if this is the first video
      if (playlist.videos.length === 1 && currentVideoIndex === -1) {
        playVideo(0);
      }
    }

    function removeVideo(videoId) {
      const playlist = getCurrentPlaylist();
      if (!playlist) return;

      const index = playlist.videos.findIndex(v => v.id === videoId);
      if (index !== -1) {
        playlist.videos.splice(index, 1);
        savePlaylists();
        generateShuffledOrder();
        renderPlaylist();

        // Adjust current index if needed
        if (index < currentVideoIndex) {
          currentVideoIndex--;
        } else if (index === currentVideoIndex) {
          if (playlist.videos.length > 0) {
            playVideo(Math.min(currentVideoIndex, playlist.videos.length - 1));
          } else {
            currentVideoIndex = -1;
            if (player && playerReady) {
              player.stopVideo();
            }
          }
        }

        emit('playlistChanged', { playlistId: playlist.id, videos: playlist.videos });
      }
    }

    // ===== Playback =====
    function playVideo(index) {
      const playlist = getCurrentPlaylist();
      if (!playlist || playlist.videos.length === 0) return;

      const actualIndex = isShuffled ? shuffledOrder[index] : index;
      if (actualIndex < 0 || actualIndex >= playlist.videos.length) return;

      currentVideoIndex = index;
      const video = playlist.videos[actualIndex];

      if (player && playerReady) {
        player.loadVideoById(video.videoId);
        isPlaying = true;
        updatePlayButton();
      }

      updateNowPlaying(video);
      renderPlaylist();
      emitVideoChanged(video, actualIndex);
      emitPreview();
    }

    function togglePlay() {
      if (!player || !playerReady) return;

      const playlist = getCurrentPlaylist();
      if (!playlist || playlist.videos.length === 0) return;

      if (currentVideoIndex === -1) {
        playVideo(0);
        return;
      }

      if (isPlaying) {
        player.pauseVideo();
      } else {
        player.playVideo();
      }
    }

    function playNext() {
      const playlist = getCurrentPlaylist();
      if (!playlist || playlist.videos.length === 0) return;

      let nextIndex = currentVideoIndex + 1;
      if (nextIndex >= playlist.videos.length) {
        nextIndex = 0; // Loop back to start
      }
      playVideo(nextIndex);
    }

    function playPrevious() {
      const playlist = getCurrentPlaylist();
      if (!playlist || playlist.videos.length === 0) return;

      let prevIndex = currentVideoIndex - 1;
      if (prevIndex < 0) {
        prevIndex = playlist.videos.length - 1;
      }
      playVideo(prevIndex);
    }

    function toggleShuffle() {
      isShuffled = !isShuffled;
      document.getElementById('shuffleBtn').classList.toggle('active', isShuffled);
      generateShuffledOrder();

      // If currently playing, re-map the current position
      if (currentVideoIndex >= 0) {
        const playlist = getCurrentPlaylist();
        if (playlist) {
          const currentVideoId = isShuffled
            ? playlist.videos[currentVideoIndex]?.videoId
            : playlist.videos[shuffledOrder.indexOf(currentVideoIndex)]?.videoId;

          // Find the new index for current video
          if (isShuffled) {
            const actualIndex = shuffledOrder.findIndex(i => i === currentVideoIndex);
            if (actualIndex !== -1) currentVideoIndex = actualIndex;
          }
        }
      }
    }

    function generateShuffledOrder() {
      const playlist = getCurrentPlaylist();
      if (!playlist) {
        shuffledOrder = [];
        return;
      }

      shuffledOrder = Array.from({ length: playlist.videos.length }, (_, i) => i);

      // Fisher-Yates shuffle
      for (let i = shuffledOrder.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffledOrder[i], shuffledOrder[j]] = [shuffledOrder[j], shuffledOrder[i]];
      }
    }

    function setVolume(vol) {
      volume = Math.max(0, Math.min(100, vol));
      if (player && playerReady) {
        player.setVolume(volume);
      }
    }

    function seekTo(seconds) {
      if (player && playerReady) {
        player.seekTo(seconds, true);
      }
    }

    // ===== Event Emission =====
    function emitVideoChanged(video, index) {
      emit('videoChanged', {
        videoId: video.videoId,
        title: video.title,
        thumbnail: video.thumbnail,
        index: index
      });
    }

    function emitPlayState() {
      const playlist = getCurrentPlaylist();
      const video = playlist?.videos[isShuffled ? shuffledOrder[currentVideoIndex] : currentVideoIndex];
      emit('playStateChanged', {
        playing: isPlaying,
        videoId: video?.videoId || null
      });
    }

    function emitPreview() {
      const playlist = getCurrentPlaylist();
      if (!playlist || currentVideoIndex < 0) return;

      const actualIndex = isShuffled ? shuffledOrder[currentVideoIndex] : currentVideoIndex;
      const video = playlist.videos[actualIndex];
      if (!video) return;

      emit('preview', {
        type: 'youtube',
        videoId: video.videoId,
        title: video.title,
        thumbnail: video.thumbnail,
        timestamp: Date.now(),
        playing: isPlaying
      });
    }

    // ===== UI Rendering =====
    function renderPlaylistSelector() {
      const select = document.getElementById('playlistSelect');
      select.innerHTML = playlists.map(p =>
        `<option value="${p.id}">${p.name}</option>`
      ).join('');

      if (currentPlaylistId) {
        select.value = currentPlaylistId;
      }
    }

    function renderPlaylist() {
      const container = document.getElementById('playlistContent');
      const emptyState = document.getElementById('emptyState');
      const playlist = getCurrentPlaylist();

      if (!playlist || playlist.videos.length === 0) {
        emptyState.style.display = 'block';
        container.innerHTML = '';
        container.appendChild(emptyState);
        return;
      }

      emptyState.style.display = 'none';

      const displayOrder = isShuffled
        ? shuffledOrder.map((actualIdx, displayIdx) => ({ video: playlist.videos[actualIdx], displayIdx, actualIdx }))
        : playlist.videos.map((video, idx) => ({ video, displayIdx: idx, actualIdx: idx }));

      container.innerHTML = displayOrder.map(({ video, displayIdx, actualIdx }) => `
        <div class="video-item ${displayIdx === currentVideoIndex ? 'active' : ''}" data-index="${displayIdx}">
          <img class="video-thumb" src="${video.thumbnail}" alt="" loading="lazy">
          <div class="video-info">
            <div class="video-title">${escapeHtml(video.title)}</div>
            <div class="video-meta">${isShuffled ? `#${displayIdx + 1}` : `#${actualIdx + 1}`}</div>
          </div>
          <div class="video-actions">
            <button class="btn" data-remove="${video.id}">âœ•</button>
          </div>
        </div>
      `).join('');

      // Event listeners
      container.querySelectorAll('.video-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (e.target.hasAttribute('data-remove')) {
            removeVideo(e.target.getAttribute('data-remove'));
          } else {
            playVideo(parseInt(item.dataset.index));
          }
        });
      });
    }

    function updatePlayButton() {
      const icon = document.getElementById('playIcon');
      if (isPlaying) {
        icon.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
      } else {
        icon.innerHTML = '<path d="M8 5v14l11-7z"/>';
      }
    }

    function updateNowPlaying(video) {
      document.getElementById('nowPlaying').innerHTML = video
        ? `Now playing: <span>${escapeHtml(video.title)}</span>`
        : 'No video selected';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ===== Storage =====
    function savePlaylists() {
      try {
        localStorage.setItem('youtube-playlist-widget', JSON.stringify({
          playlists,
          currentPlaylistId,
          isShuffled
        }));
      } catch (e) {
        console.error('Failed to save playlists:', e);
      }
    }

    function loadPlaylists() {
      try {
        const data = JSON.parse(localStorage.getItem('youtube-playlist-widget'));
        if (data) {
          playlists = data.playlists || [];
          currentPlaylistId = data.currentPlaylistId;
          isShuffled = data.isShuffled || false;
        }
      } catch (e) {
        console.error('Failed to load playlists:', e);
      }

      if (playlists.length === 0) {
        createPlaylist('My Playlist');
      } else {
        if (!currentPlaylistId || !playlists.find(p => p.id === currentPlaylistId)) {
          currentPlaylistId = playlists[0].id;
        }
        generateShuffledOrder();
      }

      renderPlaylistSelector();
      renderPlaylist();
      document.getElementById('shuffleBtn').classList.toggle('active', isShuffled);
    }

    // ===== Event Listeners =====
    document.getElementById('playlistSelect').addEventListener('change', (e) => {
      selectPlaylist(e.target.value);
    });

    document.getElementById('addPlaylistBtn').addEventListener('click', () => {
      document.getElementById('newPlaylistModal').classList.add('active');
      document.getElementById('newPlaylistName').focus();
    });

    document.getElementById('deletePlaylistBtn').addEventListener('click', () => {
      if (currentPlaylistId && confirm('Delete this playlist?')) {
        deletePlaylist(currentPlaylistId);
      }
    });

    document.getElementById('cancelNewPlaylist').addEventListener('click', () => {
      document.getElementById('newPlaylistModal').classList.remove('active');
      document.getElementById('newPlaylistName').value = '';
    });

    document.getElementById('confirmNewPlaylist').addEventListener('click', () => {
      const name = document.getElementById('newPlaylistName').value.trim();
      if (name) {
        createPlaylist(name);
      }
      document.getElementById('newPlaylistModal').classList.remove('active');
      document.getElementById('newPlaylistName').value = '';
    });

    document.getElementById('newPlaylistName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('confirmNewPlaylist').click();
      }
    });

    document.getElementById('addVideoBtn').addEventListener('click', () => {
      const input = document.getElementById('videoUrlInput');
      const url = input.value.trim();
      if (url) {
        addVideo(url);
        input.value = '';
      }
    });

    document.getElementById('videoUrlInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('addVideoBtn').click();
      }
    });

    document.getElementById('playBtn').addEventListener('click', togglePlay);
    document.getElementById('nextBtn').addEventListener('click', playNext);
    document.getElementById('prevBtn').addEventListener('click', playPrevious);
    document.getElementById('shuffleBtn').addEventListener('click', toggleShuffle);

    document.getElementById('progressTrack').addEventListener('click', (e) => {
      if (!player || !playerReady) return;
      const rect = e.target.getBoundingClientRect();
      const percent = (e.clientX - rect.left) / rect.width;
      const duration = player.getDuration() || 0;
      seekTo(percent * duration);
    });

    // ===== Widget Input Handler =====
    window.addEventListener('message', (event) => {
      const data = event.data;

      if (data.type === 'pipeline:input') {
        handleInput(data.portName, data.value);
      }

      // Legacy format
      if (data.type === 'widget:event' && data.payload) {
        handleInput(data.payload.type, data.payload.payload);
      }

      // Config from parent
      if (data.type === 'widget:config') {
        if (data.payload?.config) {
          if (data.payload.config.defaultVolume !== undefined) {
            setVolume(data.payload.config.defaultVolume);
          }
          if (data.payload.config.defaultShuffle !== undefined && data.payload.config.defaultShuffle !== isShuffled) {
            toggleShuffle();
          }
        }
      }
    });

    function handleInput(port, value) {
      switch (port) {
        case 'addVideo':
          if (typeof value === 'object') {
            addVideo(value.url, value.title, value.playlistId);
          } else if (typeof value === 'string') {
            addVideo(value);
          }
          break;
        case 'removeVideo':
          removeVideo(value);
          break;
        case 'createPlaylist':
          createPlaylist(value?.name || value);
          break;
        case 'deletePlaylist':
          deletePlaylist(value);
          break;
        case 'selectPlaylist':
          selectPlaylist(value);
          break;
        case 'play':
          if (!isPlaying) togglePlay();
          break;
        case 'pause':
          if (isPlaying) togglePlay();
          break;
        case 'next':
          playNext();
          break;
        case 'previous':
          playPrevious();
          break;
        case 'shuffle':
          if (value !== isShuffled) toggleShuffle();
          break;
        case 'setVolume':
          setVolume(value);
          break;
        case 'seekTo':
          seekTo(value);
          break;
      }
    }

    // ===== Initialization =====
    loadPlaylists();
    loadYouTubeAPI();

    // Signal ready to parent
    window.parent.postMessage({ type: 'READY' }, '*');
  </script>
</body>
</html>
