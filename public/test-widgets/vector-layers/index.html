<!DOCTYPE html>
<html>
<head>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            min-height: 100vh;
            padding: 12px;
        }
        h3 {
            color: #333;
            font-size: 14px;
            margin-bottom: 12px;
            text-align: center;
        }
        .toolbar {
            display: flex;
            gap: 4px;
            margin-bottom: 10px;
        }
        .toolbar-btn {
            flex: 1;
            padding: 8px 4px;
            border: none;
            border-radius: 6px;
            background: rgba(255,255,255,0.9);
            cursor: pointer;
            font-size: 10px;
            color: #333;
            transition: all 0.15s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        .toolbar-btn:hover {
            background: #fff;
            transform: translateY(-1px);
        }
        .toolbar-btn:active {
            transform: scale(0.95);
        }
        .toolbar-btn svg {
            width: 16px;
            height: 16px;
        }
        .layers-container {
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            overflow: hidden;
            max-height: 260px;
            overflow-y: auto;
        }
        .layer-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.15s;
        }
        .layer-item:last-child {
            border-bottom: none;
        }
        .layer-item:hover {
            background: #f8f9fa;
        }
        .layer-item.selected {
            background: #e0f2fe;
        }
        .layer-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .layer-icon svg {
            width: 18px;
            height: 18px;
        }
        .layer-info {
            flex: 1;
            min-width: 0;
        }
        .layer-name {
            font-size: 12px;
            color: #333;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .layer-type {
            font-size: 10px;
            color: #999;
        }
        .layer-actions {
            display: flex;
            gap: 4px;
        }
        .layer-action-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: all 0.15s;
        }
        .layer-action-btn:hover {
            background: #e5e7eb;
            color: #333;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 12px;
        }
        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        .refresh-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.9);
            cursor: pointer;
            font-size: 11px;
            color: #666;
            transition: all 0.15s;
        }
        .refresh-btn:hover {
            background: #fff;
            color: #333;
        }
    </style>
</head>
<body>
    <h3>Layer Manager</h3>

    <div class="toolbar">
        <button class="toolbar-btn" onclick="bringToFront()" title="Bring to Front">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 19V5M5 12l7-7 7 7"/>
            </svg>
            Front
        </button>
        <button class="toolbar-btn" onclick="bringForward()" title="Bring Forward">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 15V9M9 12l3-3 3 3"/>
            </svg>
            Up
        </button>
        <button class="toolbar-btn" onclick="sendBackward()" title="Send Backward">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 9v6M9 12l3 3 3-3"/>
            </svg>
            Down
        </button>
        <button class="toolbar-btn" onclick="sendToBack()" title="Send to Back">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12l7 7 7-7"/>
            </svg>
            Back
        </button>
    </div>

    <div class="layers-container" id="layersContainer">
        <div class="empty-state" id="emptyState">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="4" y="4" width="16" height="4" rx="1"/>
                <rect x="4" y="10" width="16" height="4" rx="1"/>
                <rect x="4" y="16" width="16" height="4" rx="1"/>
            </svg>
            <div>No layers yet</div>
            <div style="font-size: 10px; margin-top: 4px;">Add shapes to see layers</div>
        </div>
    </div>

    <button class="refresh-btn" onclick="requestEntities()">
        Refresh Layers
    </button>

    <script>
        const layersContainer = document.getElementById('layersContainer');
        const emptyState = document.getElementById('emptyState');

        let entities = [];
        let selectedId = null;

        const shapeIcons = {
            rect: '<rect x="4" y="6" width="16" height="12" fill="currentColor" rx="2"/>',
            circle: '<circle cx="12" cy="12" r="8" fill="currentColor"/>',
            ellipse: '<ellipse cx="12" cy="12" rx="10" ry="6" fill="currentColor"/>',
            polygon: '<polygon points="12,4 20,20 4,20" fill="currentColor"/>',
            star: '<polygon points="12,2 14,10 22,10 16,14 18,22 12,18 6,22 8,14 2,10 10,10" fill="currentColor"/>',
            line: '<line x1="4" y1="18" x2="20" y2="6" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>',
            path: '<path d="M4,16 Q8,4 12,12 T20,8" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>'
        };

        function getShapeIcon(type) {
            return shapeIcons[type] || shapeIcons.rect;
        }

        function renderLayers() {
            if (entities.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            // Render in reverse order (top layers first)
            const reversed = [...entities].reverse();

            layersContainer.innerHTML = reversed.map((entity, index) => `
                <div class="layer-item ${entity.id === selectedId ? 'selected' : ''}"
                     onclick="selectEntity('${entity.id}')">
                    <div class="layer-icon" style="color: ${entity.fill || '#3b82f6'}">
                        <svg viewBox="0 0 24 24">${getShapeIcon(entity.type)}</svg>
                    </div>
                    <div class="layer-info">
                        <div class="layer-name">${entity.type} ${entities.length - index}</div>
                        <div class="layer-type">${entity.type}</div>
                    </div>
                </div>
            `).join('');
        }

        function selectEntity(id) {
            selectedId = id;
            renderLayers();
            // Emit selection event (canvas will handle actual selection)
        }

        function emitEvent(type, payload) {
            console.log('[Layers] Emitting:', type, payload);
            window.parent.postMessage({
                type: 'widget:emit',
                payload: { type, payload }
            }, '*');
        }

        function bringToFront() {
            emitEvent('vector:bring-to-front', {});
        }

        function bringForward() {
            emitEvent('vector:bring-forward', {});
        }

        function sendBackward() {
            emitEvent('vector:send-backward', {});
        }

        function sendToBack() {
            emitEvent('vector:send-to-back', {});
        }

        function requestEntities() {
            emitEvent('vector:get-entities', {});
        }

        // Listen for events
        window.addEventListener('message', (event) => {
            const data = event.data;
            console.log('[Layers] Message:', data);

            if (data.type === 'widget:event') {
                const eventType = data.payload?.type;
                const payload = data.payload?.payload;

                switch (eventType) {
                    case 'vector:entities-list':
                        entities = payload.entities || [];
                        renderLayers();
                        break;

                    case 'vector:entity-added':
                        // Add new entity to list
                        if (payload) {
                            entities.push(payload);
                            renderLayers();
                        }
                        break;

                    case 'vector:entity-deleted':
                        // Remove entity from list
                        if (payload?.id) {
                            entities = entities.filter(e => e.id !== payload.id);
                            if (selectedId === payload.id) {
                                selectedId = null;
                            }
                            renderLayers();
                        }
                        break;

                    case 'vector:selection-changed':
                        selectedId = payload?.id || null;
                        renderLayers();
                        break;
                }
            }
        });

        // Signal ready and request initial entities
        window.parent.postMessage({ type: 'READY' }, '*');
        console.log('[Layers] Ready');

        // Request entities after a short delay to ensure canvas is ready
        setTimeout(requestEntities, 500);
    </script>
</body>
</html>
